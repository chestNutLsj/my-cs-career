   

### 4.2.7　循环缺陷

包含循环的程序比你在开始使用循环之前看到的简单程序更有可能出错。幸运的是，在编写循环时最有可能犯下的错误类型具有某种模式，因此，我们可以告诉你怎么去发现它们。而且，有些标准技术可以帮助你定位和修正循环中的缺陷。

两种最常见的循环错误是：

·无意中造成的无限循环。

·差1错误。

让我们来依次讨论它们。

我们已经讨论过无限循环了，但是我们需要强调有关它们的一个细节。某些输入数据会导致循环终止，但是另一些数据会导致无限循环。让我们来看一个例子，假设某位朋友的支票账户透支了，银行对余额为负的账户每月都处以罚金。我们的这位朋友想编写一个程序来提醒他，如果每月存入固定的金额，多少时间才能让账户余额变成非负。我们设计了下面的代码：

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image10042.jpeg)

我们将这段代码放到完整的程序中，用一些合理的数据测试它，例如每月罚金15美元，每月存入50美元。这个程序运行得不错，所以我们把程序给了这位朋友，他运行该程序，并发现陷入了无限循环。怎么回事？我们的朋友显然对数字没概念，于是决定每个月只存入10美元。但是银行在账户余额为负时每月的罚金有15美元，所以，该账户每个月都会透支更多的钱，尽管这位朋友在不断地存钱。

这种情况貌似不可能出现。这位朋友不可能犯这种愚蠢的错误，不用考虑这种情况！但是，即便这位朋友不愚蠢，这种情况也会发生。人们偶尔也会粗心大意，这种情况无法预料。修正这个缺陷的一种方式是添加代码，测试是否会无限循环。例如，我们可以将代码修改为下面的样子：

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image10043.jpeg)

另一种常见的循环缺陷是差1错误。这种错误会导致循环重复执行其循环体多一次或少一次。这种错误可能是由于设计控制布尔表达式时的粗心而导致的。例如，如果在控制布尔表达式中应该使用<=时使用的是<，那么循环重复执行其循环体的次数就会发生错误。

另一个有关循环的控制布尔表达式的常见问题与使用==测试相等性有关。这种判等操作符在操作整数和字符时都没问题，但是在操作浮点数时，由于浮点数自身存在的近似性，会显得不那么可靠，因为==测试的是精确相等性，这种测试的结果是无法预料的。当比较浮点数时，总是应该使用包含小于或大于的操作符，例如<=。使用==或！=来比较浮点数会产生差1错误和意外的无限循环，甚至包含其他类型的错误。

差1错误很容易被忽视。如果循环多迭代了一次或者少迭代了一次，其结果可能看起来仍旧合理，但是却已谬之千里，足以给后续操作带来麻烦。我们应该总是对差1错误逐一排查，将循环的结果与你通过其他方式了解到的合理结果（例如针对简单情况用纸和笔计算的结果）进行比较。

编程窍门：总是重新测试

无论何时，只要在程序中发现了缺陷并“修正”了它，就应该重新测试程序。因为也许还有其他的缺陷在等着你，或者你在“修正”该缺陷时又引入了新的缺陷。对修改过的程序进行重新测试的过程称为回归测试。