   

## 10.6　使用流的网络通信

既然要说话，必须先倾听，那么就通过倾听来学会说话吧。

——乌拉纳·鲁米

我们已经看到过，Scanner类可以用来从文件中或键盘处读取数据。令人称奇的是，像Scanner和PrintWriter这样的类可以用于任何一种数据流！为了展示这种灵活性，我们在这里将介绍如何使用流在网络上通信。正如你将看到的，本节的代码与读写文件的代码很相似，只是这里的程序将通过互联网从计算机读取数据或向计算机发送数据。能够获得这种抽象级别，多亏了第8章讨论的多态原则。

当计算机想要通过网络彼此通信时，每台计算机都必须讲相同的语言，或者称为“协议”。当今最常用的协议是TCP/IP，即传输控制协议和网际协议，它是大多数互联网通信的基础。TCP是一种基于流的协议，流中的数据包会从发送者传输到接收者。TCP被认为是一种可靠的协议，因为它会确保接收到发送者的数据的顺序与它们被发送时的顺序相同。等待连接的程序称为服务器，而发起连接的程序称为客户端。另一种协议是UDP，即用户数据报协议。在UDP中，也会传输数据包，但是并不会对接收数据包的顺序做任何保证，甚至对数据包是否会被接收到也不做任何保证。尽管Java提供了对UDP的支持，但是我们在本节将只介绍TCP。

Java中的网络编程是用套接字实现的。套接字对网络上两个程序之间的连接的一端进行了描述。套接字由标识远程服务器的地址和本地与远程计算机的端口构成。端口会被赋予一个在0到65 535之间的整数值，用来标识要去处理从网络上接收到的数据的程序。两个应用可以绑定不同的端口。典型情况下，端口0到1024是为操作系统实现的人所共知的服务而预留的。

客户端/服务器的通信过程如图10.7所示。首先，服务器通过监听指定的端口等待连接。当某个客户端连接到这个端口时，就会创建新的套接字，用来标识该远程计算机、远程端口和本地端口。客户端也会创建类似的套接字。一旦客户端和服务器端的套接字都创建好了，就可以按照与我们读写文件相同的方式使用流来传输数据了。

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image11177.jpeg)

图10.7　经由套接字的客户端/服务器网络通信

程序清单10.12展示了如何创建一个在6789端口监听连接的简单服务器。一旦它接收到一个连接，就会通过accept（）方法返回一个新的套接字。从这个套接字中，我们创建了Scanner和PrintWriter，就像我们从文本文件中读取数据一样，只是流的源头来自于套接字。ServerSocket和Socket类都在java.net包中。一旦创建了这些流，服务器就期望客户端发送一行文本。服务器会通过对nextLine（）的调用来等待输入的编程语言名字，就像我们从键盘或文件中读取文本一样，只是这一次服务器等待的是来自网络的文本。一旦接收到文本，服务器就会发送回一条消息。当我们想要发送数据时，应该“冲刷”对应的流。最后，服务器关闭了流和套接字。

程序清单10.12　网络服务器程序

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image11178.jpeg)

程序清单10.13展示了如何创建连接到服务器的客户端。首先，我们用运行服务器的计算机名和对应的端口6789创建一个套接字。如果服务器程序和客户端程序运行在同一台计算机上，那么我们可以使用localhost作为机器的名字。否则，就必须将主机名设置为计算机的名字（例如，my.server.com）。在建立好连接后，客户端依次创建了流对象，发送了它的名字，等待答复，然后将答复打印了出来。  

程序清单10.13　网络客户端程序

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image11179.jpeg)

注意，套接字和流对象会抛出受检异常。这意味着它们的异常必须被捕获，或者在throws块中声明。如果我们运行程序清单10.12中的服务器程序，就会注意到服务器会在serverSock.accept（）调用处等待，或者说阻塞，直至有客户端连接到它。如果套接字中尚无数据可用，服务器还会在nextLine（）调用处阻塞。对于服务器而言，这种行为使得处理多个客户端连接显得很困难。在创建了和第一个客户端的连接后，如果第二个客户端也希望连接，那么服务器是不会做出响应的。这个问题的解决方案是使用线程。线程允许一个程序并发地运行，就像有多个该程序的副本在同时运行一样。在基于线程的解决方案中，服务器程序上的每个线程都可以处理和彼此不同的客户端之间的通信，这些客户端都连接到了该服务器程序。线程在本书中并不涉及，但是在更高阶的教科书中会进行讨论。  

Java还有一个URL类，可以将网站的内容读取到流中，它可以作为展示流的灵活性和多态的威力的最后一个示例。为了使用这个类，需要导入java.net.URL，创建URL对象，然后使用这个流来创建Scanner对象。从此处开始，从Scanner中执行读操作就会从该URL对象中读取数据。下面展示的代码片段会输出www.wikipedia.org的HTML。

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image11180.jpeg)

自测问题

34.套接字上下文中端口的作用是什么？

35.修改客户端，让其发送两个数字，然后读取一个数字并打印它。修改服务器端，让其读取两个数字，计算它们的和，然后将和发送回客户端。