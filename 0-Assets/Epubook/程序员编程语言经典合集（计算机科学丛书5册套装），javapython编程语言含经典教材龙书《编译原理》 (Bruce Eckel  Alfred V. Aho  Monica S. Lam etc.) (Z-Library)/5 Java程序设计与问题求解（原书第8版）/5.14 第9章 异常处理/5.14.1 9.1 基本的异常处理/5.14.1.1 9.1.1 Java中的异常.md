   

### 9.1.1　Java中的异常

大多数短小的程序都几乎不需要什么异常处理，在代码中不太容易看到它们用到的异常处理。为了简便起见，我们用一个没什么实际意思的示范程序来作为初始的示例。首先，我们编写没有使用Java异常处理工具的程序，然后，使用异常处理机制重写该程序。

在这个示例中，我们认为牛奶是日常生活中非常重要的食物，它们几乎总是不会断供，但是我们仍旧希望我们的程序可以处理牛奶断供这种极其罕见的情况。基本的代码（即假设牛奶不会断供的代码）看起来可能像下面这样：

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image10940.jpeg)

如果输入的牛奶杯数为0，即如果我们没有牛奶了，那么这段代码将产生除以0错误。为了处理这种不太可能发生的情况，即牛奶断供导致除法出错的情况，我们会添加一项对这种异常情况的检测。程序清单9.1展示了添加了这项对异常情况检测后的完程程序。

程序清单9.1　处理有问题情况的一种方式

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image10941.jpeg)

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image10942.jpeg)

现在，让我们用Java的异常处理工具来修订这个程序。除以0的除法会产生异常，因此，与避免出现这种除法不同，我们可以让它发生，但是要对产生的异常做出反应，就像在程序清单9.2中所做的那样。因为这个示例非常简单，所以实际上我们可能并不需要使用异常处理机制。与程序清单9.1中的程序相比，修订过的程序当然不会显得更简单。但是，在关键词try和catch之间的代码比原来的代码更清晰，并且提示我们要处理异常。更清晰的组织结构对于大型复杂的程序而言至关重要。

程序清单9.2　异常处理的示例

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image10943.jpeg)

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image10944.jpeg)

程序清单9.2中的代码基本上与程序清单9.1中的代码相同，只是不使用长长的if-else语句，而是使用下面这条更短的if语句：

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image10945.jpeg)

这条if语句声明：如果牛奶断供了，那么该程序应该执行一些异常操作。这种异常操作可以在catch关键词后给出。这里体现出来的思想是：正常情况由跟在关键词try后面的代码处理，而关键词catch后面跟着的代码只用于异常情况。让我们来看看其中的细节。

在Java中处理异常的基本方式是包含try-throw-catch三元组。try块的语法如下：

![](../Images/image10946.gif)

try块包含的代码是顺利运行时的基本算法，它之所以称为try块，是因为我们不能百分之百地确定所有事情都很顺利，但是我们希望试一试。

如果代码执行出了问题，我们希望抛出一个异常，这是一种表示存在某种问题的方式。因此，当我们添加了throw语句后，其基本轮廓如下：

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image10947.jpeg)

程序清单9.2中的try块就具有这种形式，并且包含下面的语句：

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image10948.jpeg)

如果执行这条throw语句，它就会用下面的表达式

![](../Images/image10949.gif)

创建一个新的预定义类Exception的对象，并且抛出这个异常对象。字符串"Exception：No milk！"是传递给Exception类的构造器的引元，这里创建的Exception对象会将这个字符串存储在该对象的实例变量中，使得它可以在随后被找回。

当抛出异常时，包围它的块中的代码就会停止执行，另一部分代码（即被称为catch块的代码）则开始执行。执行catch块称为捕获异常。当抛出异常时，它最终应该被某个catch块所捕获。在程序清单9.2中，catch块直接跟在try块的后面。

catch块看起来有点像带有一个参数的方法定义。尽管catch块不是方法定义，但是它的行为在某些方面很像方法。它是单独的代码片段，当程序在前面的try块中执行throw语句时，它就会得以执行。这条throw语句类似于方法调用，但与调用方法不同，它调用的是catch块，并且会导致catch块中的代码得以执行。

让我们来审视程序清单9.2中catch块中的第一行：

![](../Images/image10950.gif)

标识符e看起来就像是一个参数，其作用也非常像参数。因此，尽管catch块不是方法，但是我们仍旧称e为catch块参数。catch块参数对我们要捕获的异常对象赋予了名字，因此，我们可以在catch块中编写代码来操作该异常对象。catch块参数最常见的名字就是e，但是我们可以使用任何合法的标识符。

当异常对象被抛出时，它就会传递给catch块参数e，catch块中的代码就会得以执行。因此，在这种情况下，我们可以将e看作抛出的异常对象的名字。每个异常对象都有一个名为getMessage的方法，除非我们提供代码来指定该方法的行为，否则它就会获取抛出异常时通过构造器传递给异常对象的字符串。在本例中，调用e.getMessage（）会返回"Exception：No milk！"。因此，当程序清单9.2中的catch块得以执行时，它会向屏幕输出下面的行：

![](../Images/image10951.gif)

catch块参数前面的类名指定了该catch块可以捕获的异常的种类。在我们的示例中，Exception类说明这个catch块可以捕获Exception类型的异常。因此，抛出的异常对象必须是Exception类型的，这样才能被这个特定的catch块捕获。正如你将要看到的，try块中也有可能抛出其他类型的异常，所以在一个try块后面可以跟多个catch块，每个处理一种类型的异常。但是，在这些catch块中，只有一个对应于所抛出异常类型的catch块会得以执行。因为所有异常都具有Exception类型，所以在我们的示例中，单个catch块可以捕获所有异常。尽管这看起来是个不错的主意，但是通常并非如此。多个具体的catch块通常比单个通用的catch块要更好。

对于程序清单9.2中的程序，当用户输入一个正数来表示牛奶的杯数时，不会抛出任何异常，程序清单9.3展示了这种情况下的控制流，程序清单9.4展示了用户在输入0或负数来表示牛奶杯数时抛出了异常的控制流。

程序清单9.3　不抛出任何异常时的控制流

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image10952.jpeg)

程序清单9.4　抛出异常时的控制流

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image10953.jpeg)

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image10954.jpeg)

总之，try块包含了一些可以抛出异常的代码，它之所以能够抛出异常，是因为其中要么包含throw语句，要么它调用的其他方法中包含throw语句，正如你随后会看到的。throw语句通常只有在异常情况下才会执行，但是在执行时，它会抛出一个属于某个异常类的异常对象（到目前为止，Exception是我们唯一讨论过的异常类，但是后续我们很快就会讨论到别的异常类）。当抛出异常时，try块的执行就会终止，try块中剩余的所有代码都会被忽略，控制流会传递到适合的catch块。如果异常被抛出并被捕获，那么这个异常对象会被传递给catch块参数，而catch块中的语句就会得以执行。在catch块的代码执行之后，程序会从最后一个catch块后面的代码开始继续执行。因此，try块中在抛出异常的语句之后的代码都不会被执行，如程序清单9.4所示。（随后，我们将讨论没有任何适合的catch块时会发生什么。）

现在，让我们看看在try块中没有抛出任何异常时会发生什么。当try块正常执行结束没有抛出任何异常时，程序会从最后一个catch块后面的代码处继续执行。换句话说，如果没有抛出任何异常，所有相关的catch块都会被忽略，如程序清单9.3所示。

这段解释使得try-throw-catch序列看起来与if-else语句类似。它们几乎完全相同，只是抛出的异常中携带着消息，而if-else语句无法发送消息给它的某个分支。这看起来好像区别不大，但是正如你将要看到的，发送消息这种能力使得异常处理机制比if-else语句显得功能更加强大。

牢记：异常是一种对象

像下面这样的语句：

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image10955.jpeg)

不仅仅说明程序中执行了某种动作或者忘记执行某种动作，它还创建了一个携带消息的对象。在本例中，这条消息是"Illegal character."。

为了看清这一点，我们要注意，上面的语句等价于下面的语句：

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image10956.jpeg)

第一条语句调用了Exception类的构造器，创建了一个Exception类的对象。第二条语句抛出了这个异常对象。这个对象及其消息可以被某个catch块所获得，因此抛出异常的效果不仅仅是将控制流转到catch块的第一条语句上。

回顾：抛出异常

throw语句会抛出异常。

语法

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image10957.jpeg)

throw语句通常会嵌到某条if语句或if-else语句中。try块可以包含任意数量的会明确抛出异常的语句，或者是任意数量的可以抛出异常的方法调用。

示例

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image10958.jpeg)

回顾：处理异常

try和catch语句连用是处理异常的基本机制。

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image10959.jpeg)

如果在try块中抛出异常，try块中其余的代码都会被忽略，程序会从第一个匹配所抛出异常类型的catch块开始继续执行。在该catch块执行完成后，会执行最后一个catch块之后的代码。

如果在try块中没有抛出任何异常，那么在其执行完成后，程序会从最后一个catch块之后的代码开始继续执行。换句话说，如果没有抛出任何异常，所有catch块都会被忽略。每个try块后面都可以跟着多个catch块，但是每个catch块都只处理一种异常类。Catch_Block_Parameter是一个标识符，其作用是表示可能会抛出的异常的占位符。当在前面的try块中抛出Exception_Class_Name类的异常时，该异常就会被传递给Catch_Block_Parameter。catch块中的代码可能会引用Catch_Block_Parameter。Catch_Block_Parameter最常见的名字是e，你也可以使用任何合法的标识符。

回顾：getMessage方法

每个异常对象都有一个String实例变量，其中包含了一条消息，典型情况下，这条消息会阐明发生异常的原因。例如，如果异常是由下面的语句抛出的：

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image10960.jpeg)

那么这个String实例变量的值就是String_Argument。如果异常对象称为e，那么e.getMessage（）这个调用会返回这个字符串。

自测问题

1.下面的代码会产生什么样的输出？

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image10961.jpeg)

2.如果我们将自测问题1给出的代码的第一行语句中的46修改为12，会产生什么样的输出？

3.什么是异常？它是标识符、变量、方法、对象、类，还是其他什么东西？

4.下面的语句是否合法？

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image10962.jpeg)

5.在程序清单9.2的代码中，如果将下面的语句：

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image10963.jpeg)

替换为

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image10964.jpeg)

那么，程序的行为将发生什么样的变化？

6.自测问题1给出的代码中哪个部分是throw语句？

7.当throw语句得以执行时，会发生什么？你要讨论的是一般情况下普遍会发生什么，而不是仅仅只讨论自测问题1中的代码或某段其他样例代码中会发生什么。

8.在自测问题1给出的代码中，将try块标识出来。

9.在自测问题1给出的代码中，将catch块标识出来。

10.在自测问题1给出的代码中，将catch块参数标识出来。

11.将自测问题1给出的代码中的catch块修改为下面的样子后，执行起来是否存在差异？

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image10965.jpeg)

![](../Images/image10966.gif)

12.编写一条语句，它会在名为status的String变量的值为"bad"时，抛出类型为Exception的异常。getMessage找回的字符串应该为"Exception thrown：Bad Status."。你不需要编写try块和catch块。