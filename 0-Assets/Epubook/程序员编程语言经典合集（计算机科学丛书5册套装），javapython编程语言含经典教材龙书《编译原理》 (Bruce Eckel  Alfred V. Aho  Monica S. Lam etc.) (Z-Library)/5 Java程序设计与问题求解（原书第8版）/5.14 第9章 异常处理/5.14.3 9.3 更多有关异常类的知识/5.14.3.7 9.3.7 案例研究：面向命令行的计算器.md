   

### 9.3.7　案例研究：面向命令行的计算器

我们之前曾经被要求编写出能够用作计算器的程序，它与手持计算器类似。这个计算器应该可以执行加法、减法、乘法和除法。我们编写的该程序的最初版本并没有使用窗口化的界面，而是使用了简单的逐行文本输入和文本输出方式，就像本章之前的各个程序一样。

我们需要具体地定义用户的界面。我们应该告知用户输入一项操作、一个空格和一个数字，所有内容都在一行中，就像下面这个示例：

![](../Images/image11023.gif)

在操作或数字前可以包含任意数量的空白字符。当用户输入更多的操作和数字时，该程序会跟踪到目前为止执行过的操作的结果。这些结果就像是在手持计算器上显示的数字，即操作运行的结果。例如，在屏幕上，它会显示下面的内容：

![](../Images/image11024.gif)

用户可以使用下面这样的指令来执行加、减、乘、除：

![](../Images/image11025.gif)

例如，用户和程序之间可能具有下面的交互过程：

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image11026.jpeg)

用户的输入以灰色显示，而黑色的文本是程序的输出。该程序假设result的初值为0，并且会回显输入数据和展示每次计算的结果。为了终止计算，我们让用户输入大写或小写的字母E。

在接受了上面建议的界面后，就可以开始设计计算器类了。我们可以在该类中设计一个main方法，这样它就成为了一个遵循我们给出的用户界面规范的完整而简单的计算器程序。随后，我们可以设计一个更精致的界面，让计算机变得稍微更强大一些。最终，我们可以给这个计算器设计一个窗口化的界面。

我们用名为result的私有实例变量来维护当前的结果。该程序总是在将当前的结果与输入的数字做加减乘除。例如，如果用户输入：

![](../Images/image11027.gif)

并且result当前的值为80，那么result的值就会被修改为70.5。

让我们为这个类至少设计如下的方法：

·reset方法，用来将result的值复位为0。

·evaluate方法，用来计算一项操作的结果。

·doCalculation方法，用来执行一系列的操作。

·getResult访问器方法，返回实例变量result的值。

·setResult修改器方法，将实例变量result的值设置为任意指定的值。

reset、serResult和getResult方法都是常规方法，但是evaluate和doCalculation方法需要稍微思考一下。为了简化第一版代码，我们假设所有事情都会很顺利。即，不会发生任何不寻常的事情从而导致异常。我们也许会在设计程序时注意到可能会出现的异常，但是在这个类的核心功能没有设计完之前，我们不会去编写任何异常处理代码。

为了让我们的类用途更广泛，evaluate方法可以返回一项操作的结果，而不是直接更新实例变量result。因此，我们可以像下面这样指定这个方法：

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image11028.jpeg)

计算器所执行的动作的核心是由doCalculation方法执行的，我们按如下方式指定它：

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image11029.jpeg)

让我们先来开发doCalculation。该方法应该不断地重复执行下面的操作序列，直至用户输入像字母E这样的哨兵值：

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image11030.jpeg)

其中，keyboard.next（）会以字符串形式读入操作符，而charAt（0）会以字符形式返回它。nextOp和nextNumber都是局部变量，而result是实例变量。

我们将上面的代码嵌到doCalculation内部的一个循环中，就像下面这样：

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image11031.jpeg)

接下来，我们来考虑evaluate方法。我们可以编写一个像下面这样的很长的switch语句：

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image11032.jpeg)

在我们代码的上述第一项测试中，我们可以完全忽略那些对有可能会出错的事项进行描述的注释，但是，为了让这个案例研究保持简短，我们将抛出一些异常。然而，我们不会马上处理这些异常。假设我们在上面给出的除法的情况下包含下面的代码：

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image11033.jpeg)

这种方式在概念上是不错的，但是却存在一个问题：其中包含的数字是double类型的。像这样的浮点数表示的只是近似值，因此，正如在第3章所描述的，不应该使用==来测试它们是否精确相等。n2的值可能非常接近0，以至于其他数字除以它与除以0的效果相同，但是这项测试却会认为它不等于0。无论何时，只要分母非常接近0，我们就应该抛出异常。应该如何定义“非常接近0”呢？例如，我们可以认为任何小于万分之一（0.0001）的数量值都非常接近0。但是随后可能会发现这个值并非最佳选择，因此我们使用名为precision的实例变量来表示它。目前，precision的定义可以是：

![](../Images/image11034.gif)

因此，除法的情况将变为：

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image11035.jpeg)

现在，如果用户输入的字符不是表示操作符的'+'、'-'、'*'、'\'，那么会发生什么呢？我们可以在该switch语句的缺省情况中抛出另一个异常，就像下面这样：

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image11036.jpeg)

DivideByZeroException类是在程序清单9.5中定义的。UnknownOpException是我们需要定义的新异常类，它与我们编写过的其他异常类类似，程序清单9.10给出了它的定义。注意，当用户输入未知操作符时，我们希望提供的错误消息中包含这个错误的字符。因此，我们的类有一个构造器，将输入的错误操作符作为其char类型的引元。

程序清单9.10　UnknownOpException类

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image11037.jpeg)

doCalculation的方法头必须包含throws子句，表示会抛出UnknownOpException和DivideByZeroException异常类的对象，尽管doCalculation的方法体并不包含任何抛出异常的语句。throws子句之所以必需，是因为doCalculation会调用evaluate方法，而evaluate方法可以抛出UnknownOpException和DivideByZeroException对象。

到此为止，我们已经编写好了大部分的程序，除了异常处理。这个最初的程序版本如程序清单9.11所示。我们可以在编写异常处理部分之前，对其先进行调试和测试。只要用户没有输入未知操作符或试图执行除以0的除法，那么这个版本就运行得不错。

程序清单9.11　无异常情况

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image11038.jpeg)

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image11039.jpeg)

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image11040.jpeg)

一旦我们调试了程序的初级版本，就可以添加异常处理了。因为最重要的异常是UnknownOpException，所以我们先考虑它。我们已经给出了UnknownOpException类的定义，但是尚未对其做任何处理，只是在evaluate方法中抛出了它，并且在其throws子句中声明了它。evaluate方法会被doCalculation方法调用，而doCalculation方法会被main方法调用，于是，有3种典型的方式来处理这个异常：

·在evaluate方法中捕获该异常。

·在evaluate方法的throws子句中声明UnknownOpException异常，并且在do-Calculation方法中捕获该异常。

·在evaluate方法和doCalculation方法的throws子句中都声明UnknownOp-Exception异常，然后在main方法中捕获该异常。

我们会根据异常抛出时我们希望发生的事情来决定选择哪种方式。如果我们希望用户再次尝试输入操作符，那么可以选择前两种方式中的任意一种。如果我们希望重新启动整个计算，那么可以使用最后一种方式。假设我们决定使用最后这种方式，并且将try和catch块放到main方法中。这个决定会导致我们需要重写main方法，如程序清单9.12所示。在此过程中，我们引入了两个新方法——handleUnknownOpException和handle-DivideByZeroException，所有剩下要做的事情就是去定义处理异常的这两个方法。

如果查看main方法中的catch块，就会发现，当UnknownOpException被抛出时，它是由handleUnknownOpException方法处理的。我们将这个方法设计为给用户第二次机会去从头开始输入计算。如果用户在第二次机会中又输入了未知操作符，那么就会抛出另一个UnknownOpException异常，但是这次它会在handleUnknownOpException方法中捕获，并且程序会终止。（还有其他一些也很不错的用来处理UnknownOpException异常的方式，但是这里使用的方式已经是满足要求的方式了。）要想查看处理这种情况的代码，可以查看程序清单9.12中的handleUnknownOpException方法中的catch块。

如果用户试图执行除以0的操作，那么我们将直接终止程序。（也许我们可以在该程序未来的版本中执行一些更加细致的操作，但这不是现在要做的事情。）因此，handle-DivideByZeroException方法非常简单。

编程窍门：文档中应该描述所有可能发生的异常

在使用其他程序员编写的类和方法时，我们希望其文档中描述了所有可能发生的异常。这种文档可以为我们提供如何处理这些异常的思路。当编写javadoc注释和其他有关你编写的代码的文档时，要考虑到这一点。

程序清单9.12　完整的面向命令行的计算器

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image11041.jpeg)

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image11042.jpeg)

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image11043.jpeg)

自测问题

34.编写一个名为getPrecision的访问器方法，它可以添加到程序清单9.12的Calculator类中，并返回实例变量precision的值。再编写一个名为setPrecision的修改器方法，它可以将实例变量precision的值修改为任何指定的值。

35.如果运行程序清单9.11中的程序，并且输入一个该程序无法识别的未知操作符，例如%或#，会发生什么？