## 22.9　JNLP与Java Web Start

出于安全目的，我们可以为applet签名，这在https://www.mindviewllc.com上的本章在线补充材料中进行了介绍。经过签名的applet功能强大，能够有效取代应用程序，不过它们只能在浏览器中运行。这就需要在客户机上运行浏览器，从而增加了额外的开销；同时，它也限制了applet的用户界面，常常带来视觉上的混乱。因为Web浏览器有自己的菜单和工具条，它们会显示在applet的上方[^8]。

Java网络发布协议（Java Network Launch Protocol，JNLP）在保持applet优点的前提下，解决了这个问题。通过一个JNLP程序，你可以在客户机上下载和安装单机版的Java应用程序。你可以通过命令行、桌面图标，或者与你的JNLP实现一起安装的应用程序管理器来执行这个程序。应用程序甚至可以从其最初被下载的网站上运行。

JNLP应用程序可以在运行时从因特网上动态下载资源，并且能够在用户连接到因特网的情况下，自动检查程序的版本。也就是说，它能把applet的所有优点和应用程序的优点结合起来。

与applet类似，客户机系统也会小心对待JNLP应用程序的。JNLP程序是基于Web的，很容易下载，但它也可能是恶意程序。鉴于此，JNLP应用程序遵循与applet一样的沙盒安全限制。与applet类似，它们也能被部署到签名的JAR文件中，这能让用户自行选择是否信任签名人。与applet不同的是，如果它们被部署到未签名的JAR文件中，它们通过JNLP API提供的服务仍然能够请求访问客户系统上的特定资源（在程序运行期间，用户必须同意此请求）。

因为JNLP描述的是一个协议，而不是实现；所以要使用JNLP，必须要有一个实现。Java Web Start（或者简称为JAWS），是由Sun免费提供的官方参考实现，并且作为Java SE5的一部分而发布的。如果把它用于开发，那么就要确保它的JAR文件（javaws.jar）处于类路径中；最简单的解决方案是将javaws.jar的常规Java安装路径jre/lib添加到类路径中。如果从Web服务器上部署你的JNLP应用程序，必须确保服务器能够识别MIME类型application/x-java-jnlp-file。如果你用的是最新版的Tomcat服务器（http://jakarta.apache.org/tomcat），那么它已经预先配置好了。如果你用的是别的服务器，就要参考一下用户指南。

创建一个JNLP应用程序并不困难。要先编写一个标准应用程序，然后把它打包到一个JAR文件中。这时，需要提供一个启动文件——它是一个简单的XML文件，用来告诉客户端系统下载和安装这个程序所需的所有信息。如果你不准备为JAR文件签名，那么对于你将要在客户机上访问的每种类型的资源，必须使用JNLP API提供的服务进行访问。

下面是FileChooser Test.java的一种变体，它使用了JNLP服务来打开对话框，所以这个类可以被打包进未经签名的JAR文件，然后作为JNLP应用程序部署。

![846-1](../Images/image03864.jpeg)

![847-1](../Images/image03865.jpeg)

注意，FileOpenService和FileCloseService类是从javax.jnlp包导入的，在代码中没有一处是JFileChooser对话框所直接引用的。这里使用的两个服务必须使用ServiceManager.lookup()方法进行请求，客户系统上的资源只能通过此方法返回的对象进行访问。这里，客户系统中的文件通过JNLP提供的FileContent接口进行读写，任何通过诸如File或FileReader对象直接访问资源的企图都将导致抛出SecurityException异常，这与在未经签名的applet中执行这些操作得到的结果相似。如果你想用这些类，却不愿为JNLP的服务接口所限制，那么就必须对JAR文件签名。

在JnlpFile Chooser.java中，被注释的jar命令将产生必需的JAR文件。下面有一个为上面的例子准备的合适的启动文件。

![848-1](../Images/image03866.jpeg)

你会发现在（从https://www.mindviewllc.com处）下载的本书源代码文件中，这个被存为file chooser. jnlp的启动文件没有第一行和最后一行，并且与JAR文件在同一个目录中。你可以看到，这是一个XML文件，包含了一个“<jnlp>”标记。它有一些子元素，其涵义大多不言自明。

jnlp元素的spec属性可以告诉客户系统此JNLP程序所遵循的规范的版本。codebase属性指向可以找到启动文件和资源的URL。这里它指向的是本地机器上的目录，这是一个不错的测试程序的方法。注意，你需要将这个路径修改为表示你机器上的恰当目录，从而使得程序可以成功地加载它。href属性必须指定这个启动文件的名称。

information标记也有几个子元素，它们提供了有关应用程序的信息。这些信息将用于Java Web Start的管理控制台或者类似程序（它们可以安装JNLP程序，并且可以让用户从命令行运行程序，使其更快捷等等）。

resources标记与HTML文件中的applet标记功能很相似。j2se子元素指定程序运行时需要的j2se版本，jar子元素的href属性指定包含.class文件的JAR文件。jar元素还有一个download属性，它的值可以是“eager”或者“lazy”，这可以告诉JNLP的实现在程序运行之前，是否需要下载整个JAR文件。

application-desc属性能告诉JNLP实现，JAR文件中的哪个类是可执行的类，即指定程序的入口。

jnlp标记的另一个有用的子元素是security标记，这里并没有演示它。下面是一个security标记的例子：

![848-2](../Images/image03867.jpeg)

当把程序部署在一个已签名的JAR文件中时，就要使用security标记。上面的例子不需要这个标记，因为所有本地资源都是通过JNLP服务进行访问的。

还有其他一些标记可用，其细节部分可以参考规范http://java.sun.com/products/javawebstart/download-spec.html。

要想启动这个程序，你需要一个下载页面，它包含了一个链接到这个.jnlp文件的超文本链接。下面是这个页面的大致内容（没有第一行和最后一行）：

![849-1](../Images/image03868.jpeg)

一旦程序下载完毕，就可以使用管理控制台对它进行配置。如果在Windows系统上使用Java Web Start，将提示你是否为程序创建一个快捷方式以供下次使用。这个行为是可以配置的。

这里只介绍了两种JNLP服务，当前版本的JNLP规范包含了七种服务。每个服务都被设计用来执行特定的任务，比如打印，以及和剪贴板有关的剪切和粘贴等。你可以在http://java.sun.com上找到更多的信息。