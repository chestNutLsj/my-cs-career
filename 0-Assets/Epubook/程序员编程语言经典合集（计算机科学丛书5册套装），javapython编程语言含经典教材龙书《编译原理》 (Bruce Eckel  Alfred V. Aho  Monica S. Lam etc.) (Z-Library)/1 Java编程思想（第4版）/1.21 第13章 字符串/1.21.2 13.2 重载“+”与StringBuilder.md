## 13.2　重载“+”与StringBuilder

String对象是不可变的，你可以给一个String对象加任意多的别名。因为String对象具有只读特性，所以指向它的任何引用都不可能改变它的值，因此，也就不会对其他的引用有什么影响。

不可变性会带来一定的效率问题。为String对象重载的“+”操作符就是一个例子。重载的意思是，一个操作符在应用于特定的类时，被赋予了特殊的意义（用于String的“+”与“+=”是Java中仅有的两个重载过的操作符，而Java并不允许程序员重载任何操作符[^1]）。

操作符“+”可以用来连接String：

![317-1](../Images/image03053.jpeg)

可以想象一下，这段代码可能是这样工作的：String可能有一个append()方法，它会生成一个新的String对象，以包含“abc”与mango连接后的字符串。然后，该对象再与“def”相连，生成另一个新的String对象，依此类推。

这种工作方式当然也行得通，但是为了生成最终的String，此方式会产生一大堆需要垃圾回收的中间对象。我猜想，Java设计师一开始就是这么做的（这也是软件设计中的一个教训：除非你用代码将系统实现，并让它动起来，否则你无法真正了解它会有什么问题），然后他们发现其性能相当糟糕。

想看看以上代码到底是如何工作的吗，可以用JDK自带的工具javap来反编译以上代码。命令如下：

![317-2](../Images/image03054.jpeg)

这里的-c标志表示将生成JVM字节码。我剔除掉了不感兴趣的部分，然后作了一点点修改，于是有了以下的字节码：

![317-3](../Images/image03055.jpeg)

如果你有汇编语言的经验，以上代码一定看着眼熟，其中的dup与invokevirtural语句相当于Java虚拟机上的汇编语句。即使你完全不了解汇编语言也无须担心，需要注意的重点是：编译器自动引入了java.lang.StringBuilder类。虽然我们在源代码中并没有使用StringBuilder类，但是编译器却自作主张地使用了它，因为它更高效。

在这个例子中，编译器创建了一个StringBuilder对象，用以构造最终的String，并为每个字符串调用一次StringBuilder的append()方法，总计四次。最后调用toString()生成结果，并存为s（使用的命令为astore_2）。

现在，也许你会觉得可以随意使用String对象，反正编译器会为你自动地优化性能。可是在这之前，让我们更深入地看看编译器能为我们优化到什么程度。下面的程序采用两种方式生成一个String：方法一使用了多个String对象；方法二在代码中使用了StringBuilder。

![318-2](../Images/image03056.jpeg)

现在运行javap -c WitherStringBuilder，可以看到两个方法对应的（简化过的）字节码。首先是implicit()方法：

![318-3](../Images/image03057.jpeg)

注意从第8行到第35行构成了一个循环体。第8行：对堆栈中的操作数进行“大于或等于的整数比较运算”，循环结束时跳到第38行。第35行：返回循环体的起始点（第5行）。要注意的重点是：StringBuilder是在循环之内构造的，这意味着每经过循环一次，就会创建一个新的StringBuilder对象。

下面是explicit()方法对应的字节码：

![319-1](../Images/image03058.jpeg)

可以看到，不仅循环部分的代码更简短、更简单，而且它只生成了一个StringBuilder对象。显式地创建StringBuilder还允许你预先为其指定大小。如果你已经知道最终的字符串大概有多长，那预先指定StringBuilder的大小可以避免多次重新分配缓冲。

因此，当你为一个类编写toString()方法时，如果字符串操作比较简单，那就可以信赖编译器，它会为你合理地构造最终的字符串结果。但是，如果你要在toString()方法中使用循环，那么最好自己创建一个StringBuilder对象，用它来构造最终的结果。请参考以下示例：

![319-2](../Images/image03059.jpeg)

最终的结果是用append()语句一点点拼接起来的。如果你想走捷径，例如append（a+“：”+c），那编译器就会掉入陷阱，从而为你另外创建一个StringBuilder对象处理括号内的字符串操作。

如果拿不准该用哪种方式，随时可以用javap来分析你的程序。

StringBuilder提供了丰富而全面的方法，包括insert()、repleace()、substring()甚至reverse()，但是最常用的还是append()和toString()。还有delete()方法，上面的例子中我们用它删除最后一个逗号与空格，以便添加右括号。

StringBuilder是Java SE5引入的，在这之前Java用的是StringBuffer。后者是线程安全的（参见第21章），因此开销也会大些，所以在Java SE5/6中，字符串操作应该还会更快一点。

练习1：（2）分析reusing/SprinklerSystem.java的SprinklerSystem.tString()方法，看看明确地使用StringBuilder是否确实能够避免产生过多的StringBuilder对象。