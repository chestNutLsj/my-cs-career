### 21.7.7　Exchanger

Exchanger是在两个任务之间交换对象的栅栏。当这些任务进入栅栏时，它们各自拥有一个对象，当它们离开时，它们都拥有之前由对象持有的对象。Exchanger的典型应用场景是：一个任务在创建对象，这些对象的生产代价很高昂，而另一个任务在消费这些对象。通过这种方式，可以有更多的对象在被创建的同时被消费。

为了演练Exchanger类，我们将创建生产者和消费者任务，它们经由泛型和Generator，可以工作于任何类型的对象，然后我们将它们应用于Fat类。ExchangerProducer和ExchangerConsumer使用一个List<T>作为要交换的对象，它们都包含一个用于这个List<T>的Exchanger。当你调用Exchanger.exchanger()方法时，它将阻塞直至对方任务调用它自己的exchange()方法，那时，这两个exchange()方法将全部完成，而List<T>则被互换：

![768-2](../Images/image03766.jpeg)

![769-1](../Images/image03767.jpeg)

![770-1](../Images/image03768.jpeg)

在main()中，创建了用于两个任务的单一的Exchanger，以及两个用于互换的CopyOnWriteArrayList。这个特定的List变体允许在列表被遍历时调用remove()方法，而不会抛出ConcurrentModificationException异常。ExchangeProducer将填充这个List，然后将这个满列表交换为ExchangerConsumer传递给它的空列表。因为有了Exchanger，填充一个列表和消费另一个列表便可以同时发生了。

练习34：（1）修改ExchangerDemo.java，让其使用你自己的类而不是Fat。