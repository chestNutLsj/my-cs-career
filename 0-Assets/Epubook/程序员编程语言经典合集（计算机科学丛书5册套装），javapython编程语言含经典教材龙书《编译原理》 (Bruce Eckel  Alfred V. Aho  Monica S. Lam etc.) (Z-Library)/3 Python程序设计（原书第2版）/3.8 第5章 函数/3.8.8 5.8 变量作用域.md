   

## 5.8　变量作用域

随着你的程序越来越大，使用的变量越来越多，你可能会遇到一些问题，例如你无法访问在程序另一部分中定义的变量，或者两个变量的定义互相冲突。为了解决这些问题，你需要熟悉变量作用域的概念。

一个变量的作用域是指能够访问它的代码范围。例如，函数形参变量的作用域是整个函数。在下面的代码片段中，形参变量sideLength的作用域是整个cubeVolume函数而不是main函数。

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image06326.jpeg)

在函数中定义的变量被称作局部变量。如果局部变量是在一个代码块中定义的，那么它从定义的位置开始到所在函数结束的代码中都是可以访问的。例如，在下面的代码片段中，变量square的作用域如高亮部分所示。

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image06327.jpeg)

for语句中的循环变量是局部变量。和其他局部变量一样，它的作用域会被延伸到其所在的函数结束：

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image06328.jpeg)

下面是一个作用域问题的例子：

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image06329.jpeg)

注意变量sideLength的作用域。函数cubeVolume试图读取这个变量，但是失败了——变量sideLength的作用域没有延伸到main函数之外。解决方案是把它作为参数传递过去，就像5.2节那样。

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image06330.jpeg)

在不同的城市都可以有一条街道叫作“主街道”，类似地，一个Python程序中也可以有多个同名的变量

相同的变量名在一个程序中可以使用多次。例如下面程序中的result变量：

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image06331.jpeg)

每个result变量是在不同的函数中定义的，它们的作用域不会有交叉。

Python也支持全局变量：函数之外定义的变量。全局变量对于之后定义的所有函数都是可见的。然而，任何想修改全局变量的函数都必须包含一个global声明，就像：

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image06332.jpeg)

如果你删掉global声明，那么withdraw函数中的balance变量会被认为是局部变量。

一般来说，全局变量并不是一个好主意。多个函数更新全局变量时，结果很难预测。尤其在多人开发的大型程序中，每个函数的效果都必须清晰并且容易理解，这一点非常重要。你应该在程序中避免使用全局变量。

自测题

考虑下面的程序，然后回答后面的自测题。

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image06333.jpeg)

30.第10行中变量i的作用域是哪几行？

31.第8行定义的形参变量x的作用域是哪几行？

32.程序中定义了两个相同名字的局部变量并且它们的作用域没有重叠。是哪两个变量？

33.那一行定义了全局变量？

34.main函数中有个作用域使用错误，在哪里，应如何修改？

练习它　现在你可以尝试本章最后的练习：R5.9，R5.10。

编程小提示　避免全局变量

带有全局变量的程序很难维护和扩展，因为你不能再把函数看作简单地接收参数和返回结果的“黑盒子”。当函数修改全局变量时，很难理解函数调用的效果。当程序变得越来越大时，这个难度会急剧增加。尽量不要使用全局变量，而是使用函数形参变量和返回值在程序的不同部分之间交换信息。

然而，全局常量在有些场合又是推荐使用的。你可以把它们放在Python源文件的顶部然后在文件中的任何函数中访问（不允许修改）它们。访问常量时不要使用global声明。

编程实战5.4　图形：掷骰子

问题描述　计算机程序通常用来模拟投掷一个或多个骰子（见4.9.2节）。你的任务是编写一个图形程序模拟投掷5个骰子并且在图形窗口中绘制每个骰子的结果面。用户应该能够重复投掷这5个骰子，直到选择退出程序。

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image05174.jpeg)第1步　执行逐步提炼。

从较高的层面来看这个问题，只需要几步就可以。首先，创建和配置一个图形窗口。接下来，投掷骰子并绘制5个骰子的结果面。用户应该能够重复投掷骰子直到选择退出程序，所以我们会询问用户是否要再投掷一次。现在，我们有了一个简单的算法，每个独立的任务将在下面的步骤中得到解决。

![](../Images/image06334.gif)

下面是用来实现上面算法的main函数：

![](../Images/image06335.gif)

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image06336.jpeg)

传递给configureWindow函数的窗口大小是基于DIE_SIZE计算的。为了在窗口上使用两行均匀放置5个骰子，我们计算7个骰子需要的宽度，这样可以在边界和骰子之间留出一些空隙。

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image05174.jpeg)第2步　创建和配置图形窗口。

为了创建图形程序，我们首先创建一个图形窗口并且访问它的画布。这可以在另一个单独的函数configureWindow中完成。为了实现一个更加灵活的程序，我们指定一个形参变量来表示窗口大小。

![](../Images/image06337.gif)

在前面的图形程序中，我们必须使用wait方法来阻止窗口关闭。这里不再需要那个方法，因为每次在画布上绘制投掷时都会获取用户输入，这会阻止窗口关闭。

下面的函数创建并配置图形窗口，然后返回画布。注意setBackground方法的用法，它用来把窗口的背景设置为绿色。

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image06338.jpeg)

![](../Images/image06339.gif)

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image05174.jpeg)第3步　提示用户再投掷一次或退出。

每次投掷骰子之后，我们都会询问用户是再投一次还是退出程序。下面的简单函数实现了这个任务，如果要再投一次就返回True。

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image06340.jpeg)

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image05174.jpeg)第4步　投掷并绘制骰子。

我们如何投掷5个骰子呢？在4.9.2节中，你已经学会如何使用随机数生成器进行模拟。为了模拟投掷5个骰子，调用5次randint(1，6)就可以了。

绘制模拟投掷的结果要花一点心思才行。我们需要确定如何在画布上定位骰子，一个较快的方式是根据骰子的大小来摆放每个骰子，类似于在地板上铺瓷砖。

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image06341.jpeg)

下面给出了rollDice函数。我们需要在每次投掷之前清除画布来删除上一次投掷的5个骰子，所以函数调用画布的方法clear。单个骰子的绘制由下一步定义的drawDie函数完成。

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image06342.jpeg)

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image05174.jpeg)第5步　绘制单个骰子。

如何布局骰子面上的点呢？可以把骰子的面看作一个包含5行5列的网格，然后像右边的图一样在网格上定位7个可能的点。

为了绘制特定骰子值的面，我们需要在正确的位置绘制表示给定值的点。这个任务可以分解为以下几步：

![](../Images/image06343.gif)

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image06344.jpeg)

下面的drawDie函数实现了上面的算法：

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image06345.jpeg)

把所有函数放进单个Python程序文件中。

在源码ch05/worked_example_4/rolldice.py中可以查看完整的程序。