   

### 8.3.2　包含列表的字典

与唯一键关联的字典值可以是任意数据类型，包括容器。Python中字典的常见用法是保存一系列列表，其中每个列表与唯一的名字或键相关联。例如，考虑从文本文件中提取数据的问题，文件中包含一个冰淇淋零售公司的多个商店不同口味冰淇淋的年销量。

![](../Images/image07153.gif)

处理数据产生类似于下面这样的一个报表：

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image07154.jpeg)

这个报表包含每个商店每个口味的冰淇淋销量，按口味的字母顺序列出。同时还包含了按口味和按商店的总销量。

因为这个报表的记录必须按口味的字母顺序列出，我们必须在生成报表之前读取所有记录。

这个销售数据是一个包含行和列的表格数据的例子。在第6章，我们创建了包含列表的列表来存储表格数据。但是那个结构不是最佳选择，因为这些条目包含字符串和浮点数，并且必须按口味名称来排序。

我们仍然可以使用表格形式来存储这些数据，但是不使用包含列表的列表，而是使用包含列表的字典（见图8-12）。使用这个结构，表格中的每一行是字典中的一项。冰淇淋口味的名字是用来识别表格中特定行的键，每个键的值是包含该口味冰淇淋在不同商店销量的列表。

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image07155.jpeg)

图8-12　用来表示表格数据的包含列表的字典

下面给出了用来以上面的表格形式输出数据的完整解决方案。

ch08/sec03/icecreamsales.py

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image07156.jpeg)

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image07157.jpeg)

自测题

11.为什么我们不能使用包含集合的字典来存储冰淇淋口味的销售数据？

12.如果我们试图创建包含列表的集合会发生什么？

13.在buildindex.py程序中，把一个页码增加到集合时，我们没有把这个集合再添加回字典。为什么可以这样做呢？

14.编写函数搜索8.3.2节中包含列表的字典，查找任何商店中销量最高的冰淇淋口味。

15.假设8.3.2节中冰淇淋商店的老板想知道每个商店中哪个口味卖得好。特别地，对于每个商店，哪个口味销量至少是8 000美元？什么样的复杂结构可以用来回答这个问题？

练习它　现在你可以尝试本章最后的练习：R8.6，P8.6。

专题8.4　用户模块

在编写小程序时，你可以把所有代码放进单个源文件中。当你的程序越来越大或者在团队中工作时，情况就变了。你会想把程序切分到多个独立的源文件中来安排代码。

这个切分是必要的，有两个原因。首先，大程序可能包含上百个函数，如果在单个源文件中的话，非常难以管理和调试。把这些函数分散到几个源文件中，并把相关的函数分组到一起，测试和调试不同的函数就容易多了。当与其他程序员在团队中合作时，第二个原因就很明显了。多个程序员同时编辑单个源文件是非常困难的。因此，程序代码被切分开使得每个程序员可以仅负责一组独立的文件。

大型Python程序一般包含一个驱动模块和一个或多个补充模块。驱动模块包含main函数，或者如果不使用main函数的话就包含第一条可执行语句。补充模块包含支持函数和常量。

例如，我们可以把8.3.2节中的程序切分成两个模块。其中tabulardata.py模块包含从文件中读取数据和输出带有行与列总和的列表的字典的函数，salesreport.py模块是包含main函数的驱动（或主）模块。通过把程序切分成两个模块，tabulardata.py模块中的函数可以在另一个需要处理具名数字列表的程序中进行复用。

为了调用用户模块中定义的函数或者使用用户模块中定义的常量，你可以先导入这个模块，就像导入标准库模块一样：

![](../Images/image07158.gif)

然而，如果模块中定义了很多函数，使用下面的形式更容易一些：

![](../Images/image07159.gif)

使用这种形式的话，你必须在函数名前面加上模块名：

![](../Images/image07160.gif)

我们在本书配套代码中的ch08/special_topic_4/提供了两个模块。为了运行程序，你需要在命令行执行驱动模块：

![](../Images/image07161.gif)

或者使用你的集成开发环境执行驱动模块。

编程实战8.3　图形：饼状图

饼状图常用来图形化显示不同类别之间数据的分布。圆饼被切分成很多片，每个片的大小表示整体的一部分。每个片的比例和类别的简短说明常作为图的一部分进行显示，通常作为使用切片颜色把信息映射为指定片的图例。

问题描述　设计并实现一个程序，绘制饼状图和对应的图例，显示一个人在几个类别的投资的分布。

我们会使用模块化设计，把解决方案切分成3部分：绘制饼状图、创建图形数据和绘制图例。

饼状图和图例

饼状图可以通过绘制一个圆的多个弧来创建，每个片对应于图上的一个类别。你可以使用ezgraphics模块中的画布方法drawArc绘制一段弧。

![](../Images/image07162.gif)

为了绘制一段弧，你要指定限定正方形的x坐标和y坐标，就像椭圆那样，然后再指定圆的直径。你必须同时指定一个角度（0～360）来说明弧在圆上开始的位置，以及弧的角度范围或大小。

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image07163.jpeg)

为了绘制饼状图，我们可以实现一个可用来绘制任意类型数据图的通用绘图函数。绘制饼状图需要的信息包括：饼（或圆）的大小，圆的限定正方形左上角的（x，y）坐标，要绘图的画布，每个片相对于整体的比例（百分比）和每个片的颜色。

因为对于每个片我们需要多个数据值，可以使用包含字典的列表来提供这个信息。列表中的每个字典包含三项，切片的"size"、"color"和"label"。我们使用数据字段的名字作为字典的键，这样方便通过名字来访问这些字段，不需要像使用列表一样记住每个字段出现的位置。

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image07164.jpeg)

饼的每个片被绘制为独立的弧。因为每个片的数据使用单独的字典存储，我们迭代这个包含字典的列表并依次绘制每个片。

弧的大小是这个片相对于整个饼的比例。圆周有360度，所以每个片的角度范围可以计算为

![](../Images/image07165.gif)

其中slice proportion是一个百分比。为了简单，我们从0度（正x轴）开始第一个片。每下一个片开始的角度正好是前一个片结束的位置。一个片的结束角度正好是开始角度加上片的范围。下面给出了这个任务的实现：

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image07166.jpeg)

我们还想在饼状图上包括一个图例来表示每个片的类别和比例。我们的图例会为每个片包括一个带颜色的小盒子和一个短标签。图例项堆积在一起，这样看起来整洁一些。

为了在画布上绘制图例，我们再次实现一个适用于任何类型图的通用函数。对于这个函数，我们需要一个限定盒子左上角的（x，y）坐标，需要在上面绘制图例的画布，以及每个片的颜色、标签和大小。因为图例很可能会用于饼状图，我们使用包含字典的列表向drawLegend函数传递片信息。这允许我们在两个绘图函数中使用同样的结构。为了绘制图例，每个字典需要三项，"size"、"color"和"label"。下面给出了drawLegend函数的实现：

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image07167.jpeg)

因为drawPieChart和drawLegend函数是有关的，我们可以把这两个实现放进单个模块（piechart.py）中。把这两个函数从程序的剩余部分分离出来，我们可以很容易地在另一个需要绘制饼状图或图例的程序中复用其中一个或两个。

股票投资组合

该程序的第二个模块中的函数用来从文件中提取股票投资组合和构建两个绘图函数所需要的包含字典的列表。为了简单，我们假设文本文件包含下面格式的股票分配数据：

![](../Images/image07168.gif)

每行包含一条记录，其中有3个字段：股票符号，股票类别，持有该股票的美元数量。

为了按类别演示股票的分布，我们需要计算持有每个类别的总数量。我们使用字典结构，其中每个键表示一个类别，对应的值是该类别中股票的总数量。每条记录从文件中提取时，我们检查字典确定是否已经包含该类别。如果没有的话，我们增加一个新项，使用当前记录的数量。如果该类别已在字典中，那么就给它的值增加当前记录中的数量。提取完所有记录之后，函数返回字典：

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image07169.jpeg)

![](../Images/image07170.gif)

为了绘制饼状图和图例，我们必须接收loadAllocations函数返回的类别分配并构建drawPieChart和drawLegend函数所需要的包含字典的列表。完成这个任务的函数需要计算按类别的股票分配百分比，但是每个类别的颜色和描述可以硬编码。

这个任务的函数实现如下：

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image07171.jpeg)

驱动模块

驱动模块导入两个自定义模块piechart和portfolio，以及ezgraphics模块，并提供main函数：

![](../Images/image07172.gif)

下面给出了实现这些简单步骤的Python代码。为了支持任意大小的饼状图，我们定义一个常量表示其大小，用来计算窗口的大小和图例的位置。

![](../Images/image07173.gif)

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image07174.jpeg)

在配套源码的ch08/worked__example_3文件夹中可以找到完整的股票分配程序。

工具箱8.1　从网上收集JSON数据

很多Web应用程序提供可以在其他程序中使用的数据。Web应用是与指定的URL建立连接时由Web服务器执行的程序。有些Web应用构建用来在浏览器中显示的网页，还有些可以返回数据。为了从Web应用获取数据，你需要通过应用编程接口（Application Programming Interface，API）访问网站。API指定网页地址和必须提供的任何参数以便能够生成预期的结果。

为了共享或交换数据，Web应用通常使用JSON（JavaScript Object Notation）格式。JSON是一种允许使用简单文本在不同应用之间交换数据的标准数据格式，对于有多个字段的大记录数据尤其有用。

在本节中你会学习到如何使用Python的json模块处理JSON格式的Web数据。

假设你想知道伦敦的当前天气情况。你可以编写程序从openweathermap.org网站下载这个信息。为了获得这个数据，你首先获得网址：

![](../Images/image07175.gif)

在打开Web连接之前追加城市名字和测量单位作为参数：

![](../Images/image07176.gif)

然后数据被读取进一个大块并转换为字符串：

![](../Images/image07177.gif)

这个字符串包含JSON格式的数据（为了可读性，下面给出了整理后的内容）：

![](../Images/image07178.gif)

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image07179.jpeg)

如你所见，JSON使用和Python列表与字典一样的标记。

为了在你的程序中使用这些数据，必须从JSON格式转换为字典。使用json模块的loads完成这个转换：

![](../Images/image07180.gif)

作为转换的一部分，每个数据值根据JSON格式的定义（字符串必须包含在双引号之内，数字也遵循和Python同样的约定）被转换为对应的数据类型。这样，数据不需要进一步转换任何数据字段就可以直接使用：

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image07181.jpeg)

前面已经提到，在打开连接时你可能需要使用URL参数给Web应用提供信息。Web应用openweathermap.org至少需要城市的名字，但是我们也提供了要返回的温度和风数据的单位。

有时，作为参数传递的数据可能包含空格或特殊字符，而合法的URL不能包含这样的字符。为了帮助生成合法的URL，你可以使用urllib.parse模块的urlencode函数，让Python帮你完成这个工作。

首先，创建一个字典，其中每个形参保存为键，对应的实参保存为该键的值：

![](../Images/image07182.gif)

然后，根据字典创建一个URL编码的字符串并追加到网址后面，中间插入一个"?"：

![](../Images/image07183.gif)

下面是获取用户指定位置的当前天气情况的完整程序：

ch08/toolbox_1/weather.py

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image07184.jpeg)