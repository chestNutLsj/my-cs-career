   

## 11.1　再看三角数

第5章包含了一个编写递归函数的简单介绍，所谓递归函数也就是使用更小的输入调用它们自己的函数。在那一章，你看到了如何输出下面这样的三角形：

![](../Images/image07599.gif)

要点在于，假设你知道如何输出图中灰色的更小的三角形模式，你就可以输出给定边长的三角形模式。

在本节中，我们将稍微修改一下那个例子，使用递归来计算边长为n的三角形的面积，假设每个[]方括号的面积为1。这个值有时被称为第n个三角数。例如，通过观察上面的三角形，你可以说出第三个三角数是6，第四个三角数是10。

如果三角形的边长为1，那么这个三角形只包含一个方括号，面积是1。我们首先考虑这个情况：

![](../Images/image07600.gif)

为了处理通用的情况，假设你已经知道了更小的灰色三角形的面积。那么你可以很容易地计算更大的三角形的面积为

![](../Images/image07601.gif)

如何得到更小的面积呢？调用triangleArea函数！

![](../Images/image07602.gif)

现在你可以完成triangleArea函数了：

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image07603.jpeg)

计算边长为4的三角形的面积时，会发生下面的事情。

·执行triangleArea函数，形参变量sideLength被设置为4。

·把smallerSideLength设置为3，使用参数smallerSideLength调用triangleArea函数。

·那个函数调用拥有自己的一组形参变量和局部变量，它的sideLength形参变量为3，并且把它的smallerSideLength变量设置为2。

·再次调用triangleArea函数，现在使用参数2。

·在那个函数调用中，sideLength为2而smallerSideLength为1。

·使用参数1调用triangleArea函数。

—那个函数调用返回1。

·返回值被保存到smallerArea中，函数返回smallerArea+sideLength=1+2=3。

·在这一层中，smallerArea被设置为3，函数返回smallArea+sideLength=3+3=6。

·函数把smallerArea设置为6，然后返回smallerArea+sideLength=6+4=10。

如你所见，函数多次调用自己，每次的参数越来越简单，直到遇到一个非常简单的情况。然后递归函数调用再一个接一个地返回。

尽管很容易理解这种模式的递归调用，大部分人并没有发现它在设计或理解递归方案时思考调用模式有很大帮助。相反，再看一次triangleArea函数。第一部分是很容易理解的，如果边长为1，那么面积当然是1。接下来的部分好像也是合理的。计算更小的三角形的面积。不用担心那如何工作——把函数看作一个黑盒子，简单地认为你会得到正确答案就可以了。然后大三角形的面积很明显是小三角形面积与边长的和。

一个函数不停地调用自己时，你会困惑如何知道这些调用最终会结束。有两个条件需要得到满足：

·每次递归调用必须以某种方式简化计算。

·必须有个特殊情况（有时称作基本用例）能够直接处理最简单的计算。

triangleArea函数使用越来越小的边长值不停地调用自己，最终边长必须到达1，并且有个特殊情况用来计算边长为1的三角形的面积。这样，triangleArea函数总是可以成功。

实际上，你必须非常小心。如果计算边长为-1的三角形面积，会发生什么？它会计算连长为-2的三角形面积，而进一步计算边长为-3的三角形面积，依此类推。为了避免这个问题，你应该为triangleArea函数增加一个条件：

![](../Images/image07604.gif)

为了计算三角数，并不是必须要使用递归。一个三角形的面积等于下面的和

![](../Images/image07605.gif)

当然，我们可以编写一个简单的循环：

![](../Images/image07606.gif)

很多简单的递归可以使用循环来计算。然而，复杂递归的等价循环——编程实战11.1和11.5节中的例子——会非常难以理解。

实际上，在这种情况下，你甚至不需要使用循环就可以计算答案。前n个正数的和可以这样计算：

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image07607.jpeg)

这样，上面的面积可以简单地计算为：

![](../Images/image07608.gif)

因此，计算这个问题既不需要递归也不需要循环。上面使用的递归可以看作是为接下来的几节做的一个“热身”。

ch11/sec01/trianglenumbers.py

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image07609.jpeg)

程序运行结果

![](../Images/image07610.gif)

自测题

1.在最终版本的triangleArea函数中，为什么语句if sideLength==1：return 1不是必需的？

2.如何修改程序来递归计算一个正方形的面积？

3.在某些文化中，包含数字8的数字被认为是吉祥数字。下面试图测试一个数字是否为吉祥数字的函数有什么错误？

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image07611.jpeg)

4.为了计算2的幂，你可以先计算小一次的幂然后乘以2。例如，如果你想计算211，并且已经知道210=1024，那么211=2×1024=2048。基于这个观察，编写递归函数pow2(n)。

5.考虑下面的递归函数：

![](../Images/image07612.gif)

mystery(4)的结果是什么？

练习它　现在你可以尝试本章最后的练习：P11.1，P11.2，P11.10。

常见错误11.1　无限递归

一个常见的编程错误是无限递归：一个函数一次又一次地调用自己，并且在可预见的范围内不会结束。计算机需要一定数量的内存来记录每次调用。一定次数的调用之后，用于这个目的的所有内存将会被耗尽，你的程序会崩溃并且报告栈溢出错误。

发生无限递归要么是因为参数没有变得越来越简单，要么因为缺少了特殊的结束用例。例如，假设triangleArea函数允许计算边长为0的三角形面积。如果它不是用作特殊用例，函数会继续构造边长为-1、-2、-3等的三角性。

专题11.1　使用对象递归

如果你感觉一个函数能够调用自己有点困惑，那么你可能会发现下面的面向对象的变形有些帮助。让我们实现一个带getArea方法的Triangle类：

![](../Images/image07613.gif)

首先考虑基本用例：

![](../Images/image07614.gif)

现在继续处理一般情况。假设小三角形的面积是已知的，那么很容易计算出大三角形的面积为smallerArea+self._sideLength。

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image07615.jpeg)

如何得到更小的面积呢？只需要问一下小三角形就可以了！

![](../Images/image07616.gif)

这里我们调用一个不同对象上的getArea方法。对于很多人而言，这个递归不会让人惊讶。

本例的代码见ch11/special_topic_1/triangle.py和triangletester.py。