   

### 7.4.4　处理BMP文件

为了演示二进制文件的处理，我们会编写一个可以用来编辑BMP图像文件的Python程序。

到此为止，我们已经知道如何以读模式或写模式打开文件。但是一个文件也可以打开之后同时支持读和写两种操作，在open函数的模式字符串中包含一个加号（+）字符就可以：

![](../Images/image06924.gif)

以同时支持读和写的模式打开文件，你可以从文件中读取数据，处理这些数据，然后再写回文件中，一般是写回到读取时相同的位置。这在处理图像文件时是比较常见的任务。

打开文件之后，可以从头部提取图像的尺度和像素数据的起始位置：

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image06925.jpeg)

readInt函数是前面介绍的用来把4个连续字节转换为一个整数的算法的一个版本：

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image06926.jpeg)

唯一的区别是我们使用seek方法首先把文件标记移动到有关信息在BMP文件中保存的位置。

start的值表示第一个像素的第一个字节保存的位置。为了提取独立的字节，我们必须把文件标记移动到那个位置。

![](../Images/image06927.gif)

现在就可以处理这些独立的像素了。

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image06928.jpeg)

我们会对一个数字图像应用一个简单的滤波器，把图像替换为它的负图。也就是，把白色像素变成黑色，把青色变成红色，等等，就像我们在4.10节中做的那样。

为了创建一个BMP图像的负图，首先提取每个像素的蓝/绿/红分量值：

![](../Images/image06929.gif)

然后使用下面的公式调整这些值：

![](../Images/image06930.gif)

调整完像素之后，新的值必须写回到文件中读取时的相同位置：

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image06931.jpeg)

下面给出了把BMP图像转换为负图的完整程序。和4.10节中的程序不同，这个程序没有显示图像。相反，它读取并更新保存图像的文件。练习P7.24和练习P7.25要求生成更多有意思的效果。

ch07/sec04/imageproc.py

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image06932.jpeg)

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image06933.jpeg)

自测题

17.在普通的英语中，下面的代码片段做的是什么？

![](../Images/image06934.gif)

18.你如何修改imageproc.py程序来翻转每个像素的绿色和蓝色实现幻觉效果？

19.如果你对同一个图像文件运行两次Imageproc.py程序，会发生什么？

20.我们可以只使用顺序访问来实现图像处理程序吗？如果不能的话，为什么不能？

21.假设一个BMP文件保存了一个BMP格式的100×100像素的图像，图像数据从偏移量64开始。这个文件的总大小是什么？

练习它　现在你可以尝试本章最后的练习：R7.9，R7.10，P7.24。

编程实战7.2　图形：显示一个场景文件

一些绘图应用程序允许你创建和保存包含各种对象的场景以便后期可以编辑这些独立的对象。为了保存场景，程序创建一个保存场景中每个对象及其特征的数据文件。

问题描述　开发一个图形程序从文本文件中读取场景描述并在图形窗口中绘制场景。

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image05174.jpeg)第1步　理解处理任务。

为了提取场景数据，你必须首先理解用来保存这些数据使用的格式。

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image06935.jpeg)

我们的文件格式使用多行保存与画布相关的数据，每行保存一个对象的数据。例如，下面的文本文件保存了右图显示的简单灯柱场景。

![](../Images/image06936.gif)

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image06937.jpeg)

这个格式假设文件中没有空行，以井号（#）开头的行是将被忽略的注释。所有非注释的行包含场景有关的数据。必须要有的前三行包含画布有关的参数：画布的宽度和高度，以及背景颜色。后面的非注释行包含绘制4个对象（直线、矩形、椭圆或文本）中每一个所需要的参数。

每个对象的数据字段在同一行上，使用逗号进行分隔。所有对象的前4个字段是一样的，有：

·对象类型，

·各种画布方法定义的x坐标和y坐标，以及

·线框颜色。

对象类型使用下面的字符串之一来表示："line"、"rect"、"oval"或"text"。线框颜色和填充色必须使用名字来指定。

可选字段依赖于特定对象。对于文本对象，有一个附加字段用来表示要绘制的文本。对于矩形和椭圆，有3个附加字段：填充色和两个用来指定矩形或椭圆的限定矩形的宽度和高度。直线对象的两个附加字段用来指定直线终点的x坐标和y坐标。

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image05174.jpeg)第2步　使用自顶向下的方法定义算法。

在顶层来看，解决问题的算法非常简单：

![](../Images/image06938.gif)

为了简单，我们在程序中直接指定了文件名。为了让程序更加有用，文件名应该通过提示或者命令行从用户那里获得。我们会创建3个主要任务的函数：配置窗口，读取对象描述，和绘制一个对象。

下面的main函数实现了这个算法：

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image06939.jpeg)

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image05174.jpeg)第3步　创建和配置图形窗口。

这个步骤比较简单，从输入文件中提取前3个值然后使用它们创建和配置图形窗口：

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image06940.jpeg)

比较难的地方是从输入文件中实际提取数据，这在下一步中描述。

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image05174.jpeg)第4步　从文件中提取非注释行。

文件中以井号开头的任意行被当作注释。提取单个值或数据行不再像从文件中读取一行一样简单。相反，我们不得不跳过所有注释并提取第一个非注释行。因为这必须在每次从文件中读取时完成，我们会创建一个执行该任务的辅助函数。

为了跳过注释，我们从文件中读取一行并测试其第一个字符是否为井号。如果不是的话，返回该行。如果是井号的话，我们再读取和测试一行，直到发现非注释行或者遇到文件尾：

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image06941.jpeg)

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image05174.jpeg)第5步　读取一个对象描述并绘制该对象。

数据文件的每个非注释行（除去画布的3个参数）包含一个对象描述。读取该行之后，可以被切分成5个部分——所有对象共有的前4个字段和切分后第5部分包含的剩余字段。我们这样做是因为文本对象的最后一个字段包含要绘制的文本，并且这个文本中可能会含有逗号。为了防止逗号导致额外的切分，我们把切分次数限定为4，保持表示文本对象的字符串不动。

切分原始字符串之后，我们设置对象的线框颜色，因为所有对象都有一个线框颜色。接下来，检查要绘制的对象的类型。如果对象是文本对象，我们简单地绘制切分后最后一部分的字符串。对于其他对象类型，字符串包含2个或3个值。这些会是直线终点的x坐标和y坐标或者矩形或椭圆的填充色、宽度和高度。我们再次切分字符串来获取这些值。读取描述并绘制对象的函数为：

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image06942.jpeg)

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image05174.jpeg)第6步　把所有函数放进单个Python源文件中。

在源码的ch07/worked_example_2/drawscene.py中可以查看完整的程序。