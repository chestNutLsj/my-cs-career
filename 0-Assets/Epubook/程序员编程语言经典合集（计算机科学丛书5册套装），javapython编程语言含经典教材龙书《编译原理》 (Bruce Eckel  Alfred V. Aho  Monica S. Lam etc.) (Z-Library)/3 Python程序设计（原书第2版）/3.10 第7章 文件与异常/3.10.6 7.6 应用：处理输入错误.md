   

## 7.6　应用：处理输入错误

这一节会完成一个包含异常处理的示例程序。程序analyzedata.py要求用户输入一个文件名，其中预期是包含数据值的。文件的第一行应该包含值的总数量，剩余行包含数据。典型的输入文件看起来就像：

![](../Images/image06970.gif)

可能会出现什么错误呢？有两个主要的危险。

·文件不存在。

·文件可能包含错误格式的数据。

谁可以检测这些错误？如果文件不存在，open函数会抛出异常。处理输入值的函数在发现数据格式错误时需要抛出异常。

会抛出什么异常呢？文件不存在时open函数抛出IOError异常，这在我们的情况中是合适的。如果数据项比预期的少，或者文件不以值的数量开头，程序会抛出ValueError异常。

最后，如果有多于预期的输入，应该抛出一个包含合适信息的RuntimeError异常。

谁可以补救异常报告的错误呢？在analyzedata.py程序中只有main函数和用户进行交互，所以由这个函数来处理这些异常，输出合适的错误信息，并给用户提供机会输入正确的文件：

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image06971.jpeg)

如果遇到坏数据或者文件不存在，main函数中的前两个except子句会给出一个人类可读的错误报告。如果有多于预期的值，第三个except子句会输出一个错误报告。因为没有可用于这种类型错误的标准异常，我们会使用通用的RuntimeError异常。一般地，这个异常可用于多个类型的错误。处理这个异常时，程序应该输出异常抛出时提供的信息。这需要使用as运算符访问异常对象并将其转换为字符串。

如果有不同于main函数捕获的异常被抛出，程序会终止并输出异常信息及其被抛出的行号。另外，这个输出会包含一个导致异常的函数调用链以及调用处的行号。这可以帮助程序员来诊断问题。

下面的readFile函数创建一个文件对象并调用readData函数，不会处理任何异常。如果输入文件有问题，文件不存在或者包含非法数据，这个函数会简单地把错误传递给它的调用者。

![](../Images/image06972.gif)

注意finally子句是如何保证即使出现异常也能保证关闭文件的。

readData函数读取值的数量，创建一个列表并使用数据值填充它。

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image06973.jpeg)

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image06974.jpeg)

有3个潜在的错误：

·文件可能不以整数开始。

·可能没有足够数量的数据值。

·可能在读完所有数据值之后还有额外的输入。

在前两种情况下，当我们试图把输入字符串转换为整数时int函数抛出ValueError异常。因为在这种情况下该函数不知道做什么，允许异常被发送到其他地方的处理程序。

当我们发现额外的非预期输入时，抛出一个RuntimeError异常并指定合适的信息。为了理解工作中的异常处理，让我们看一个特定的错误场景：

1.main调用readFile。

2.readFile调用readData。

3.readData调用int。

4.输入中没有整数，int抛出ValueError异常。

5.readData没有except子句，立即终止。

6.readFile没有except子句，执行finally子句和关闭文件之后立即终止。

7.main函数中的第一个except子句是负责处理IOError异常的。正在被抛出的异常是ValueError，这个处理程序不适用。

8.下一个except子句是负责ValueError，从这里恢复执行。处理程序显示给用户一个信息，然后用户有机会再次输入一个文件名。注意，处理数据的语句被跳过去了。

这个例子显示了错误检测（在readData函数中）和错误处理（在main函数中）的分离，二者之间是readFile函数，只负责传递异常。

ch07/sec06/analyzedata.py

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image06975.jpeg)

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image06976.jpeg)

自测题

27.为什么readFile函数不处理任何异常？

28.考虑一下readFile函数中的try/finally语句，为什么文件在try块之外打开？

29.假设用户指定了一个存在的空文件，跟踪analyzedata.py程序的执行流程。

30.readData函数为什么不检查输入行来确保文件中没有足够值时不抛出ValueError异常呢？

练习它　现在你可以尝试本章最后的练习：R7.19，P7.13。

工具箱7.4　统计分析

Python常用于数据分析，提供了很多统计函数。标准库中有用于计算平均值、中值和标准差的函数。另外，scipy.stats模块有大量用于测试统计变量之间相关性的函数。在这个工具箱中，你会学到这些函数的几个有趣的应用。（如果你还没有安装scipy库的话，参考工具箱2.1。）

基本统计测量

标准库模块statistics提供了用于计算一系列值的平均值、中值和标准差的函数：

![](../Images/image06977.gif)

例如，数据包含世界上国家的人口时，平均值大概是3 000万，而中值约为460万。极少数人口稠密的国家拉高了这个平均值。在这里，标准差（约122百万）不是很有用。

为了查看一个更加有用的标准差的例子，考虑符合正态分布或钟形分布的数据。正态分布的常见例子是一个物种中个体的大小。对于正态分布的数据，预期约68%的数量在平均值的一个标准差之内，约96%的数量在两个标准差之内。示例程序（源码中的ch07/toolbox_4/basic/stats.py）显示，美国总统的身高平均值为180cm（5'11"）并且标准差约为7cm。这样的话，白宫居住者矮于166cm（5'5"）或高于194cm（6'4"）的概率小于4%。

卡方检验

统计学中一个常见的应用是测试两个变量之间是否有显著差别。例如，我们可能想确定男生和女生的考试成绩是否会变化，或者是否受家庭收入的影响。有两种类型的变量：分类变量和连续变量。分类变量有固定数量的可能值，没有与每个值相关的数字值，例如男生/女生或者种族分类。连续变量（例如测试成绩、收入或身高）可以假设是数字值的一个连续范围。

卡方检验分析分类变量之间的关系。例如，美国人口普查局发布了按种族和西班牙裔分类的多种出生数据——见表7-7。

表7-7　2008年出生率

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image06978.jpeg)

直观上看，双胞胎和三胞胎的可能性应该依赖于种族或父母的种族地位。但是，奇怪的是西班牙裔和黑人的数量很相似，即使西班牙裔儿童的数量高出70%。当然，在任何观察中，你都会期望有一个随机波动。卡方检验测量在给定值矩阵时两个变量互相独立的概率。

对于这种类型的统计分析，你需要使用scipy库的scipy.stats模块，导入scipy.stats模块然后调用chi2_contingency函数。该函数返回一个包含几个值的元组，其中只有第二个值是基本分析所关注的，它是独立单元格的变化可能会偶然出现的概率。

![](../Images/image06979.gif)

![](../Images/image06980.gif)

在这种情况下，p值为0，表示区别与概率无关，多胞胎独立于种族的假设不成立。肯定有概率之外的其他原因使得西班牙裔双胞胎更少。

另一个统计（如表7-8所示）按种族和西班牙裔列出了顺产和剖腹产的数据。有人可能会疑惑剖腹产在弱势群体中更少见，因为这个过程要花费一些费用。然而，在这种情况下，卡方检验报告这个分布偶然发生的概率为0.68，所以我们不能得出结论说不同群体之间有区别。在源码的ch07/toolbox_4/chi2/chi2.py程序中可以查看分析出生数据的完整程序。

表7-8　按种族和西班牙裔分类的2008年分娩情况（以千为单位）

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image06981.jpeg)

方差分析

方差分析（通常简称ANOVA）用来确定分类变量和连续变量之间的从属关系。例如，你可以使用方差分析来确定测试成绩是否在不同学生群体之间有显著区别。

国际评估方案（The Programme for International Assessment，PISA）每三年在70多个国家执行一次，用来评估15岁学生的表现。（关于这个测试更详细的描述可查阅[http://www.oecd.org/pisa/aboutpisa/](http://www.oecd.org/pisa/aboutpisa/)。）可以获得多个国家的原始数据。我们会分析来自美国的2012年学生数据。这个数据集提供了参与测试的约5 000名学生中每个人的匿名记录，带有人口统计数据和个人问题的回答。

其中一组数据询问学生每周英语学习的数量。（有两个问题，一个询问每节课的分钟数，另一个询问每周的上课时间。）假设我们想检查是否不同的种族群体都能得到同样数量的指导和学习。

数据文件非常大但是很容易使用本章的工具进行处理。每个学生的记录占用一行。偏移量和每个字段的长度也已记录，这允许我们提取性别、种族和学习的小时数。

下面是提取学习小时数并加到合适的组的代码：

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image06982.jpeg)

![](../Images/image06983.gif)

然后我们输出每一组的大小和平均值。

![](../Images/image06984.gif)

如你所见，这意味着不同群体之间是有区别的，平均而言黑人比白人少30分钟。这个区别很明显吗，或者它是随机出现的吗？这正是ANOVA测试的内容。stats.f_oneway函数根据传递给它的列表来计算数据分布可能是随机结果的概率。该函数返回一个元组，其中第二个元素是概率。在我们的应用中，我们计算

![](../Images/image06985.gif)

在我们的例子中，p值是0.027 774，或者略低于3%，所以可以得出结论认为数据分布不可能是随机的结果。

作为检验，我们也按性别对英语学习时间进行分组。程序给出这样的信息：

![](../Images/image06986.gif)

这意味着非常相似，ANOVA检验结果认为分布相同的概率超过50%。这并不奇怪，因为在美国学校的男生和女生不总是有同样的英语课。

在源码的ch07/toolbox_4/anova/anova.py中可以查看分析学生数据的完整程序。

线性回归

在前面，我们分析了分类变量和连续变量之间的关系。如果两个变量都是连续的，你可以使用叫作线性回归的另一个测试来检验变量之间是否存在线性依赖关系。

作为数据源，我们从OECD Factbook（[http://www.oecd-ilibrary.org/economics/oecd-factbook_18147364](http://www.oecd-ilibrary.org/economics/oecd-factbook_18147364)）提取不同工业化国家的统计指标并保存到CSV文件中。每一行列出特定国家的值：

![](../Images/image06987.gif)

让我们研究一下医疗保健费和平均寿命之间的关系。医疗保健费高的话国民寿命会长吗？

我们使用CSV读取器来读取这些数据，把平均寿命和医疗保健费的值分别追加到两个列表中。

![](../Images/image06988.gif)

现在我们可以计算线性相关系数了，这是个介于-1和1之间的值，表示数据之间线性关系有多密切——见图7-5。接近于+1或-1的相关系数表示对应的数据点落在一条直线上，相关系数为0的话意味着这些点组成的形状根本不是线性的。

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image06989.jpeg)

图7-5　线性相关系数示例

函数scipy.stats.linregress计算线性相关系数以及回归直线（最佳拟合这些数据点的直线）的斜率和x轴上的截距。同样，函数的结果也是元组，前三个元素分别为斜率、截距和系数。

![](../Images/image06990.gif)

在我们的情况中，系数为0.3588 64，非常弱。让我们绘制这些数据点和回归直线：

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image06991.jpeg)

图7-6显示的绘制结果。

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image06992.jpeg)

图7-6　医疗保健费用和寿命之间的相关性

看上去有个离群值，有个国家比其他国家花费了更多的医疗保健费但是没有在寿命上得到相应的回报。没错，那就是美国。删除外围的数据点会得到约0.61的系数（见练习P7.40）。在源码中的ch07/toolbox_4/regression/regression.py可以查看完整程序。

你已经看了几个使用统计函数分析真实数据的例子。有更多这样的函数，一个好主意是参加统计方面的课程来了解不同场景中使用哪个函数更合适。我们希望你在研究领域中分析数据时习惯于使用Python。

编程实战7.3　创建一个泡泡图

问题描述　泡泡图演示三维数据之间的关系，也就是说，每个数据点由3个值(x，y，z)组成。每个数据点绘制成一个圆，或者“泡泡”。在图形上泡泡的中心由x值和y值来确定，而z值用来确定泡泡的大小。

你的任务是使用matplotlib库（如果还没有安装这个库的话参考工具箱2.1）创建一个泡泡图说明一个国家的年度教育投入和学生在数学与科学方面的测试成绩之间的关系。数据存储在一个文本文件中。

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image06993.jpeg)

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image05174.jpeg)第1步　把任务分解为多个步骤。

这个问题可以分解为3个步骤：

![](../Images/image06994.gif)

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image05174.jpeg)第2步　理解处理任务。

为了从文件中加载数据，你需要理解数据存储的格式。下面是education.txt文件的内容：

![](../Images/image06995.gif)

![](../Images/image06996.gif)

每条记录有4部分信息，共占用两行。第一行指定国家。第二行包含该国家的平均教育资金投入（以美元为单位），后面是该国家完成中等教育的学生的平均数学成绩和平均科学成绩。每个成绩的最高分都是600分。

为了得到国家的名字，你简单地读取第一行即可。为了获取每个国家对应的3个值，切分第二行并把3个字符串转换成相应的类型：

![](../Images/image06997.gif)

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image05174.jpeg)第3步　在迭代整个文件和读取独立行之间做出选择。

因为每条记录在文件中占用两行，我们需要每次读取两行来获取一条记录。

![](../Images/image06998.gif)

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image05174.jpeg)第4步　选择如何存储数据。

泡泡图使用pyplot模块中的scatter函数来创建。该函数接受3个列表，每个列表中包含与每个点相关的3个值中的一个。所以我们会把x值（数学成绩）存储到一个列表，y值（科学成绩）存储到另一个列表，z值（投入）存储到第三个列表。这样的话，每个列表中对应的元素会包含单个数据点的值。

我们还想为每个泡泡加上标签，所以会在第四个列表中存储国家的名字。

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image05174.jpeg)第5步　加载图形数据。

加载数据的算法是：

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image06999.jpeg)

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image05174.jpeg)第6步　绘制数据。

pyplot模块的scatter函数需要4个参数：x值列表，y值列表，z值列表和颜色。

在我们的例子中，我们不关心泡泡的颜色是什么。我们只是想每个泡泡有不同的颜色。Python会分配一个随机颜色，但是我们会传递一个不同整数的列表（默认颜色表的索引）确保每个颜色是不同的。

![](../Images/image07000.gif)

我们还想为每个泡泡加上标签，这可以通过循环国家名字并把每个国家的标签放置到泡泡的位置即可：

![](../Images/image07001.gif)

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image05174.jpeg)第7步　改进图形外观。

最后一步是通过增加标题和为坐标轴设置标签来改进图形外观。为了更容易观察，我们还打开了网格。

下面给出了完整的程序：

ch07/worked_example_3/bubblechart.py

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image07002.jpeg)

计算与社会7.2　阿丽亚娜火箭事件

欧洲航天局（ESA），美国国家航空航天局（NASA）的竞争对手，已经成功往太空发送了多颗卫星并进行了相关的科学实验。然而，1996年6月4日从库鲁法属圭亚那发射新火箭阿丽亚娜5时，火箭在发射40秒后偏离了预定轨道。火箭没有垂直飞行，而是偏离了20多度，空气阻力太大导致推进器分离，触发了自毁机制。火箭自己爆炸了。

这次事故的最终原因是一个没处理的异常！火箭包含两个完全一样的设备（叫作惯性参考系统）用来处理测量设备的数据并把数据变为火箭位置有关的信息。自带的计算机使用这个位置信息来控制推进器。同样的惯性参考系统和计算机软件在阿丽亚娜4上工作良好。

然而，由于火箭的设计发生了改变，其中一个传感器测量到了比阿丽亚娜4中更强的加速力。这个值是使用浮点数表示的，但是保存在一个16位整型变量中。这个设备软件使用的Ada语言在浮点数太大而无法转换为整数时会产生异常。不幸的是，这个设备的程序员认为这种情况永远不会发生，没有提供异常处理程序。

当溢出确实发生时，异常被触发，但是由于没有处理程序，所以设备自行关闭了。自带的计算检测到这个失败并切换到备用设备。然而，那个设备也因为同样的原因自行关闭了，这是火箭设计者没有预料到的。他们考虑到了设备可能会因为机械原因为失败，但是认为两个设备具有同样的机械故障的概率是非常低的。那时，火箭没有可靠的位置信息，所以偏离了轨道。

如果软件不是这么敏感，或许会好一些。如果软件忽略这个溢出，设备就不会关闭，而是会计算错误数据。但是接下来设备会报告错误的位置数据，这一样是致命的。相反，一个正确的实现应该捕获溢出异常并采取一定的策略来重新计算飞行数据。很明显，在这个场合中，放弃不是一个合理的选择。

异常处理机制的优点是让程序员更清楚这些问题。

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image07003.jpeg)

阿丽亚娜火箭爆炸