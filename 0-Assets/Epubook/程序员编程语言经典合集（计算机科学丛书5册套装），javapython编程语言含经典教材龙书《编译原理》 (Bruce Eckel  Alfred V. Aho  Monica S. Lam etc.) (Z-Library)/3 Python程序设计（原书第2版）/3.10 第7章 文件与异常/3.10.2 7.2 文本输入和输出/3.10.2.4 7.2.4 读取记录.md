   

### 7.2.4　读取记录

一个文本文件可以包含数据记录的集合，每个记录中包含多个字段。例如，一个包含学生数据的文件可能包含由身份证号、完整名字、地址和年级这些字段组成的记录。一个包含银行账号交易的文件可能包含由交易日期、描述和金额这些字段组成的记录。

处理包含数据记录的文本文件时，你一般不得不先读取整个记录然后再进行处理：

![](../Images/image06826.gif)

然而，记录的组织形式或格式是变化的，使得有些格式比另一些格式更容易读取。考虑CIA Fact Book网站（[http://www.cia.gov/library/publications/the-world-factbook/index.html](http://www.cia.gov/library/publications/the-world-factbook/index.html)）上包含人口数据的一个简单的示例文件。每个记录包含两个字段：国家名字及其人口。这样数据的经典格式是每个字段存储为文件的一行，单个记录的所有字段连续存储：

![](../Images/image06827.gif)

读取这样格式的数据非常容易。因为每个记录包含两个字段，我们从文件中读取两行来构成一个记录。这需要使用readline方法和一个检查文件尾（警戒值）的while循环：

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image06828.jpeg)

第一条记录的第一个字段必须通过“预读取”来获得，防止文件中不包含记录。一旦进入循环，从文件中读取该记录的剩余字段。从字符串字段的尾部删除换行符，包含数字字段的字符串被转换成它们合适的类型（这里是int）。在循环体的尾部，下一条记录的第一个字段通过“修改读取”来获得。

另一种常用的格式把每个数据记录存储为文件中的一行。如果记录的字段之间使用特定的分隔符进行分隔，

![](../Images/image06829.gif)

你可以使用7.2.2节描述的split方法对行进行切分并提取字段。

![](../Images/image06830.gif)

但是，如果字段之间没有使用分隔符，该怎么办呢？

![](../Images/image06831.gif)

因为有些国家名字多于一个单词，我们不能简单地使用空格作为分隔符，那样的话多单词的名字会被错误地切分。读取这种格式的数据的一个方法是，读取一行，然后搜索readline返回的字符串中第一个数字：

![](../Images/image06832.gif)

然后你可以使用切片操作（见专题6.2）提取国家名字和人口作为子字符串：

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image06833.jpeg)

或者，你可以使用字符串方法rsplit从尾部开始切分字符串。例如，如果line包含字符串：

![](../Images/image06834.gif)

语句：

![](../Images/image06835.gif)

从字符串尾部开始遇到的第一个空格的位置把字符串切分成两部分。

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image06836.jpeg)

注意，rsplit方法得到的子字符串按它们在字符串中出现的顺序保存到列表中。

表7-5给出了文件操作。

表7-5　文件操作

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image06837.jpeg)

下面的程序用来读取和处理包含文本和数字的数据记录。

ch07/sec02/items.py

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image06838.jpeg)

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image06839.jpeg)

自测题

7.假设输入文件包含一行文本Hello，World!。执行下面的代码之后word1和word2的值是什么？

![](../Images/image06840.gif)

8.假设输入文件包含工资和名字数据作为单行文本

![](../Images/image06841.gif)

你如何提取工资和名字？

9.假设输入文件包含单行文本

![](../Images/image06842.gif)

执行下面的代码段之后x1和x2的值是什么？

![](../Images/image06843.gif)

10.你的输入文件包含一系列数字，每行一个数字，但是有时候值不可用并被标记为N/A。你如何读取这些数字并跳过这些标记？

11.你如何补全7.2.3节的示例程序并输出26个字母和它们的次数？

练习它　现在你可以尝试本章最后的练习：P7.2，P7.4，P7.5。

专题7.1　读取整个文件

有两种方法可以读取整个文件。调用inputFile.read()返回包含文件中所有字符的字符串。readlines方法读取文本文件中的全部内容并放入一个列表：

![](../Images/image06844.gif)

方法readlines返回的列表中的每个元素是包含文件中一行（包括换行符）的字符串。一旦文件的内容被读入列表，你可以通过位置来访问列表中的行，例如listOfLines[2]。你也可以迭代整个列表：

![](../Images/image06845.gif)

这些方法在你需要加载小文件内容时非常有用。然而，对于大文件你应该避免使用它们，因为它们可能需要大量内存来存储所有的字符串。

专题7.2　正则表达式

正则表达式描述字符模式。例如，数字具有简单的形式，它们包含一位或多位数字。描述数字的正则表达式是[0-9]+。集合[0-9]表示0和9之间的任意一位数字，+表示“一个或多个”。

专业编程编辑器的搜索命令理解正则表达式，并且，有一些实用程序使用正则表达式来定位匹配的文本。比较常用的一个使用正则表达式的程序是grep（代表“global regular expression print”）。你可以在命令行环境运行grep。grep是UNIX操作系统的一部分，也有适用于Windows系统的版本。它需要一个正则表达式和一个或多个要搜索的文件。运行grep时，显示能够匹配正则表达式的那些行。

假设你想查找一个文件中所有的幻数（见编程小提示2.2）。

![](../Images/image06846.gif)

列出包含数字序列的文件homework.py中的所有行。那并不是非常有用，带有变量名字x1的行也会被列出。

好的，你想得到不紧跟在字母后面的数字序列：

![](../Images/image06847.gif)

集合[^A-Za-z]表示不在A到Z和a到z这个范围的任意字符。这样就好多了，值显示包含纯数字的行。

标准库re中包含一个特殊版本的split函数，可以接收一个描述分隔符（分隔单词的文本块）的正则表达式：

![](../Images/image06848.gif)

在这个例子中，字符串在所有的非字母处进行分隔。

关于正则表达式的更多信息，使用搜索引擎搜索“regular expression tutorial”然后查阅互联网上的众多指南或说明书即可。

专题7.3　字符编码

一个字符（例如字母A，数字0，标注了重音的字符é，希腊字母π，符号∫，或者中文字符中）被编码为一系列字节，每个字节的值介于0和255之间。

不幸的是，编码并不统一。1963年，ASCII（美国信息交换标准代码）定义了128个字符的编码。ASCII对所有大写和小写的拉丁字母及数字，以及+*%这样的符号，编码为0到127之间的数字。例如，字母A的编码为65。

不同的人群需要对自己的字符集进行编码，他们设计了自己的编码。其中很多都是基于ASCII的，使用128到255之间的数字来编码自己的语言。例如，西班牙语中，字母é被编码为233，而在希腊语中代码233表示字母ι（小写字母iota）。和你想象的一样，如果名字叫José的西班牙旅行家给希腊旅馆发送邮寄，这会出现问题。

为了解决这个问题，1987年开始设计Unicode。正如在计算与社会2.1中描述的，世界上每个字符都给定一个唯一的整数值。然而，那些数字仍有多种二进制的编码形式。最流行的编码叫作UTF-8，使用1到4个字节对一个字符进行编码。例如，A仍像ASCII那样编码为65，但是é的编码是195 169。

编码的细节并不重要，只要在读写文件时指定使用UTF-8编码即可。

在本书印刷时，Windows和Macintosh操作系统还没有切换到UTF-8。Python使用基于操作系统的字符编码（这又依赖于用户居住的地区），除非你明确指定了其他编码，open函数返回的文件对象会以操作系统默认的编码来读写文件。如果你的文件中只包含ASCII字符，或者创建者和接收者使用同样的编码，那当然是没有问题的。但是，如果你需要处理包含标注了重音的字符、中文字符或者特殊符号，你应该明确指定使用UTF-8编码。使用下面的方式打开文件

![](../Images/image06849.gif)

你可能会想Python为什么不直接判断出字符编码。然而，考虑字符串José。在UTF-8中，它的编码是74 111 115 195 169。用于表示Jos的前3个字节都在ASCII范围之内，是没有问题的。但是接下来的两个字节，195 169，可能是UTF-8的é，也可能是传统西班牙编码中的Ã¡。解释器不认识西班牙语，无法确定选择哪个编码。因此，在与世界上其他地方的用户交换文件时你应该总是指定UTF-8编码。

工具箱7.1　处理CSV文件

你已经知道如何读写文本文件和处理不同格式的数据，但是如果要处理保存在电子表格中的数据时该怎么办呢？例如，假设你需要打印20世纪90年代发行的所有电影的清单，这些清单来自于一个电子表格，如下所示。

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image06850.jpeg)

很多电子表格应用程序使用专用的文件格式来保存数据，这样的格式无法通过其他程序直接访问。幸运的是，大部分应用程序支持使用一种叫CSV（Comma-Separated Values）的轻便格式来保存数据副本。CSV文件就是普通的文本文件，其中每行保存了电子表格中的一行数据。每行中的数据使用逗号进行分隔。例如，根据上面显示的电子表格生成的CSV文件中包含：

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image06851.jpeg)

CSV非常常用，所以Python标准库提供了处理它们的工具。在这一节中，我们学习csv模块和如何使用Python处理CSV文件。

读取CSV文件

为了读取一个CSV文件的内容，你必须以规则的文本文件格式来打开它，

![](../Images/image06852.gif)

然后使用reader函数创建一个CSV文件读取器：

![](../Images/image06853.gif)

你可以使用for循环来迭代CSV读取器对象中的数据。例如，

![](../Images/image06854.gif)

读取并以下面的格式输出CSV文件中的每行数据：

![](../Images/image06855.gif)

循环中的每次迭代中，从文件中读取一个完整行的数据并以字符串列表的形式保存到循环变量row中。对于每一行，这个列表可以像任何其他列表一样处理。这里，我们完成原始任务，输出20世纪90年代发行的所有电影的标题：

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image06856.jpeg)

因为数据被读取并保存为字符串列表，你在使用之前必须把数字值转换为合适的数值格式。在循环中，我们在测试之前把year的值转换为整数。

你可以对CSV读取器使用Python的next函数来跳过一行。例如，如果一个电子表格包含描述信息，例如标题或列的头部，你可以跳过包含那个信息的行：

![](../Images/image06857.gif)

创建CSV文件

为了使用Python程序创建一个CSV文件，首先使用open函数创建一个新的文本文件：

![](../Images/image06858.gif)

然后使用csv模块的writer函数创建一个CSV写入器：

![](../Images/image06859.gif)

为了向CSV文件中增加一行数据，使用writerow方法。把包含一行数据的列表传递给这个方法即可。例如，为了增加一行列头部，你会传递一个字符串列表，每个字符串表示电子表格中的一列。

![](../Images/image06860.gif)

你可以增加数字或文本与数字的混合：

![](../Images/image06861.gif)

为了在CSV文件中跳过一行，你可以给writerow方法传递一个空列表。

![](../Images/image06862.gif)

把数据写入CSV文件之后，你必须记得关闭文件：

![](../Images/image06863.gif)

处理CSV文件

这里是一个同时演示读写CSV文件的例子。假设你的任务是创建一个新的CSV文件，其中包含来自于更大集合的电影数据的有限信息。特别地，新文件中应该只包含20世纪90年发行的电影的标题、发行年份和演员清单。如果输入的CSV文件包含5列：

![](../Images/image06864.gif)

那么新文件中应该只包含前两列和最后一列并且只包含20世纪90年代的那些行的数据，同时应该有合适的列头部。

下面的程序完成了这个任务。

ch07/toolbox_1/filter.py

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image06865.jpeg)

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image06866.jpeg)