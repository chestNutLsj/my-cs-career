   

### 10.2.3　病毒扫描

我们现在使用递归开发一个病毒扫描程序，即一个系统地检查文件系统中的每一个文件并打印包含已知计算机病毒特征的文件名称的程序。病毒特征（virus signature）是一个特定的字符串，它是文件中病毒存在的证据。

知识拓展：病毒和病毒扫描程序

计算机病毒是一个小程序，通常在用户不知情的情况下，附加或合并到驻留在用户的计算机的文件中，当病毒执行时会对计算机造成伤害。例如，计算机病毒可能会破坏或删除计算机上的数据。

病毒是一种可执行程序，就像其他程序一样，作为字节序列被存储在一个文件中。如果计算机病毒由计算机安全专家识别并获知其字节序列，那么检查文件是否包含病毒所需做的全部工作是检查该字节序列是否出现在文件中。事实上，寻找完整的字节序列并不是必需的，搜索这个序列中精心挑选的片段足以高概率地识别病毒。这个片段被称为病毒特征：它是病毒代码中出现的字节序列，但不太可能出现在未感染的文件中。

病毒扫描程序周期性地、系统地扫描计算机文件系统中的每个文件，并检查它们是否感染了病毒。病毒扫描程序包含一个病毒特征列表，并且会定期自动更新。程序检查每个文件是否存在列表中的某些病毒特征，如果文件包含病毒特征，则对其进行标记。

我们使用字典来存储各种病毒特征。它把病毒名称映射到病毒特征：

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image09126.jpeg)

（虽然字典中的名称是真实的病毒名称，但病毒特征是虚假的。）

病毒扫描函数带两个输入参数：病毒特征字典和父文件夹或文件的路径（字符串）。程序访问父文件夹及其子文件夹（子文件夹中的子文件夹，以此类推）中的每个文件。图10-8显示了一个示例文件夹“test”以及它直接或间接包含的所有文件和子文件夹。病毒扫描程序将访问图10-8中的每个文件，并输出如下所示的结果：

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image09127.jpeg)

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image09128.jpeg)

图10-8　文件系统片段。其中显示了文件夹“test”及其下的所有子文件夹和文件

由于一个文件系统的递归结构（一个文件夹包含文件和其他文件夹），我们使用递归开发病毒扫描函数scan()。当输入路径名是一个文件的路径名时，函数应该打开和读取文件内容，并查找文件中是否包含病毒特征码，这是基本情况。当输入路径名是一个文件夹的路径名时，scan()应该在输入文件夹中的每个文件和子文件夹上递归调用自身，这是递归步骤。完整的实现代码如下：

模块：ch10.py

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image09129.jpeg)

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image09130.jpeg)

程序使用了标准库模块os中的函数。模块os包含了对操作系统资源（例如文件系统）提供访问的函数。我们使用了如下三个os模块函数：

a.listdir()。函数带一个输入参数：一个文件夹的绝对路径或相对路径（字符串），返回输入文件夹中的所有文件和子文件夹。

b.path.isfile()。函数带一个输入参数：一个文件夹的绝对路径或相对路径（字符串），如果路径指向一个普通文件，则返回True，否则返回False。

c.path.join()。带两个路径作为输入参数，把它们合并成一个新的路径（根据需要插入\或/）并返回新路径。

我们进一步解释为什么需要第三个函数。函数listdir()返回的不是一个路径列表，而是一个文件和子文件夹名称列表。例如，当我们开始执行scan('test')（省略了scan()的第二个参数）时，函数listdir()的调用如下：

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image09131.jpeg)

如果我们递归调用scan('folder1')，则当该函数调用开始执行时，函数listdir()将在路径'folder1'上调用，结果出错：

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image09132.jpeg)

问题是执行scan('test')过程中当前路径是包含文件夹test的文件夹，其中不存在文件夹'folder1'，因而出错。

为了取代函数调用scan('folder1')，我们需要在一个绝对路径或是相对于当前工作目录的相对路径上调用scan()函数。按照下列方式拼接'test'和'folder1'，可以获得'folder1'的路径：

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image09133.jpeg)

（在Windows系统上），或者更一般地，按照下列方式拼接pathname和item：

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image09134.jpeg)

上述代码在Windows机器上可以正常工作，但在UNIX、Linux或MAC OS X机器上会出错，因为在这些操作系统上使用正斜杠（/）。一个更好的可移植的解决方案是使用模块os中的函数path.join()。它适用于所有的操作系统，因而与操作系统无关。例如在一个Mac机器上：

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image09135.jpeg)

相同的例子在Windows系统上的执行结果如下：

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image09136.jpeg)