   

### 12.4.2　multiprocessing模块中的Pool类

如果你的计算机具有多个内核的微处理器，则可以将一些Python程序的执行分成若干任务，这些任务可以由不同的内核并行运行。在Python中这样做的一个方法是使用标准库模块multiprocessing。

如果不知道你的计算机有多少个内核，可以使用模块multiprocessing中的函数cpu_count()来获取：

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image09395.jpeg)

你的计算机可能拥有更少或更多的内核。有了八个内核，从理论上讲程序执行速度可以快八倍。要达到这个速度，你必须把你要解决的问题分成八个相等的大小，然后让每个内核并行处理一块。不幸的是，并不是所有的问题都能被分解成同样大小的碎片。但也存在一些问题（特别是数据处理问题）是可以这样划分的，它们激发了本节的讨论。

我们使用multiprocessing模块中的Pool类将一个问题分割成碎片然后并行执行。一个Pool对象表示一个或者多个进程的进程池，每个进程都可以独立地在可用的处理器内核中执行。

知识拓展：什么是进程？

一个进程通常被定义为“执行中的程序”，但这意味着什么呢？当一个程序在计算机上执行时，它在一个“环境”中执行。这个“环境”跟踪所有的程序指令、变量、程序栈、CPU的状态，等等。这个“环境”是由底层操作系统创建的，以支持程序的执行。这个“环境”就是我们所说的一个进程。

现代计算机是多处理技术，这意味着它们可以并发运行多个程序（或者更准确地说，多个进程）。并发这个词并不意味着“同时”，在单个内核的微处理器计算机体系结构中，只有一个进程可以在给定的时间点上执行。在这种情况下，并发意味着，在任何给定的时间点上，都有多个进程（执行中的程序），其中一个进程实际上使用CPU并正在执行，其他进程被中断，等待操作系统将CPU分配给它们。在多核计算机体系结构，情况是不同的：几个进程可以在同一时间在不同的内核上运行。

我们在一个简单的示例中演示类Pool的使用方法：

模块：parallel.py

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image09396.jpeg)

这个程序使用包括两个进程的进程池来计算列表animals中字符串的长度。当你在系统的命令行（不是Python交互式命令行）中执行此程序时，结果如下：

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image09397.jpeg)

因此，在程序parallel.py中，map()方法把函数len()应用到列表animals的每一个项，然后返回获得值的新列表。表达式：

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image09398.jpeg)

和列表解析表达式：

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image09399.jpeg)

二者执行相同的操作，求值计算结果值相同。唯一的不同之处在于如何操作。

与列表解析方法不同，在基于Pool的方法中使用两个进程把函数len()应用到列表animals的每一个项。如果主机至少包括两个内核，则处理器可以同时（即并行）执行两个进程。

要演示两个进程同时执行的效果，我们修改程序parallel.py以显式展示处理列表animals中不同项的不同进程。要区分不同进程，我们使用一个方便的事实：每个进程都有一个唯一的整数ID。进程的ID可以使用标准库模块os中的getpid()函数获得：

模块：parallel.py

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image09400.jpeg)

和len()一样，函数length()带一个字符串参数，返回其长度，同时还输出执行该函数的进程的ID。当我们在系统的命令行（不是Python交互式命令行）中执行此程序时，结果类似如下：

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image09401.jpeg)

因此，ID为36715的进程处理字符串'hawk'和'hog'，而ID为36716的进程处理字符串'hen'和'hyena'。在具有多个内核的计算机上，进程可以完全并行执行。

注意事项：为什么不在交互式命令行中运行并行程序？

由于超出本书范围的技术原因，在某些操作系统平台上不可能在交互式命令行中使用Pool运行程序。出于这个原因，我们在主机操作系统的命令行中运行所有使用进程池的程序。

要更改parallel2.py中进程池的大小，只需要改变Pool构造函数的输入参数。当使用Pool()默认构造函数（即没有指定进程池大小时）构建一个进程池时，Python会自己确定分配多少个进程。分配的进程数不会超过主机的内核数。

练习题12.7　编写程序notParallel.py，一个parallel2.py的列表解析版本。运行并检查使用了多少个进程。然后运行parallel2.py若干次：进程池大小分别为1、3、4，以及使用Pool()默认构造函数。