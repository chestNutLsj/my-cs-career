   

### 12.2.4　使用sqlite3查询数据库

接下来我们将展示如何从Python程序中执行SQL查询。我们在数据库文件links.db上执行查询操作，该数据库文件中包含如图12-2所示的表Hyperlinks和Keywords。

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image09345.jpeg)

为了执行一条SQL的SELECT语句，我们只需要把该语句作为一个字符串参数传递给游标的execute()方法：

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image09346.jpeg)

SELECT应该返回一个结果表。那么，结果表在哪儿呢？

该表存储在Cursor对象本身中。如果想要访问它，可以使用下列几种方式获取它。要获取选定的记录为一个元组，可以使用（Cursor类的）fetchall()方法：

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image09347.jpeg)

另一种方法是将Cursor对象cur直接作为一个迭代器，并迭代访问：

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image09348.jpeg)

第二种方法具有内存高效的优点，因为不用在内存中存储大的列表。

如果查询使用存储在Python变量中的值该怎么办？假设我们想知道哪些网页包含word的值，其中word的定义如下：

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image09349.jpeg)

再次，我们可以使用参数替换：

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image09350.jpeg)

word的值替换了SQL查询中的占位符位置。让我们确认该查询确实查出了包含单词“Paris”的所有网页：

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image09351.jpeg)

让我们尝试一个使用两个Python变量值的示例。假设我们想知道包含单词word出现频率多于n次的网页URL，其中：

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image09352.jpeg)

我们再次使用图12-11所示的参数替换：

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image09353.jpeg)

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image09354.jpeg)

图12-11　两个参数SQL替换。第一个参数匹配第一个占位符，第二个参数匹配第二个占位符

注意事项：两个游标的陷阱

如果执行了cur.execute()语句之后，运行下列命令：

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image09355.jpeg)

将得到预期的结果表。然而，如果再次运行cur.fetchall()：

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image09356.jpeg)

结果为空。问题关键在于：fetchall()将清空Cursor对象缓冲区。如果通过迭代Cursor对象获取结果表中的记录，情况也是如此。

如果没有获取前一次查询的结果，执行SQL查询会产生另一个问题：

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image09357.jpeg)

fetchall()返回仅第二次查询的结果。第一次查询的结果被丢失。

练习题12.4　搜索引擎是一个服务应用程序，从用户处获取一个关键字，返回包含该关键字的网页URL，并根据某个特定的准则对网页排序。在本练习题中，要求开发一个简单的搜索引擎，基于频率对网页进行排序。

编写一个搜索引擎应用程序。该搜索引擎应用程序基于一个如图12-2b所示的数据库表Keywords，该表存储网页爬虫结果所搜寻到的单词出现频率。搜索引擎应用程序将提示用户输入一个关键字，然后简单地返回包含该关键字的网页，按照关键字的出现频率降序排列。

![](0-Assets/Epubook/程序员编程语言经典合集（计算机科学丛书5册套装），javapython编程语言含经典教材龙书《编译原理》%20(Bruce%20Eckel%20%20Alfred%20V.%20Aho%20%20Monica%20S.%20Lam%20etc.)%20(Z-Library)/images/image09358.jpeg)