## I/O 设备
### I/O 外设分类
1. **人可读**：用于计算机与用户间交互，如打印机、终端（键盘、显示器）、鼠标等；
2. **机器可读**：用于电子设备通信，如磁盘驱动器、USB 密钥、传感器、控制器、执行器等；
3. **通信**：用于远程设备通信，如数字线路驱动器、调至解调器等；

### I/O 外设间差异
1. **数据传输速率**
2. **设备用途**：设备用途对 OS 及支持设施中的软件和策略都有影响，如存储文件的磁盘需要文件管理系统，终端被不同特权级用户使用导致优先级不同
3. **控制复杂性**：不同设备的行为控制显然不同，复杂度不同
4. **数据传送单位**：按字节、或字符流、或块（簇）传送
5. **数据表示**：不同设备的数据编码方式不同，包括字符编码、奇偶校验约定、汉明码等冗余位；
6. **错误条件**：错误的性质、报告错误的方式、错误造成的后果、有效的相应范围

## I/O 功能组织

I/O 技术有三种：
1. **程序控制 I/O**：处理器代表进程给 I/O 模块发送 I/O 命令，该进程忙等待直到操作完成；
2. **中断驱动 I/O**：处理器代表进程给 I/O 模块发送 I/O 命令，若 I/O 指令是非阻塞的，则处理器继续执行 I/O 命令的后续指令；若是阻塞的，则处理器执行的下一条指令来自 OS，将当前进程设置为阻塞态并调度其它就绪进程；
3. **直接内存访问 DMA**：DMA 模块控制内存和 I/O 模块之间的数据交换，为传送一块数据，处理器给 DMA 模块发送请求，且只有整个数据块传送结束后才向 CPU 发送中断请求

![[Pasted image 20230828172150.png]]
### I/O 功能的发展阶段
1. **直接控制**：CPU 直接控制外围设备
2. **抽象控制程序，分离底层接口**：CPU 使用非中断的程序控制 I/O，增加了控制器（I/O 模块），CPU 开始从外部设备接口的具体细节中分离出来
3. **引入中断**：CPU 不必等待 I/O 操作的执行
4. **引入 DMA**：I/O 模块通过 DMA 直接控制存储器，不必 CPU 参与，仅在传送开始和结束时需要 CPU
5. **I/O 专用处理器**：I/O 模块专设单独处理器，有专门的指令集，CPU 只指导 I/O 处理器执行内存中的特定 I/O 程序（*408 中的通道技术*），I/O 处理器自行取指执行完成程序规定的任务，CPU 因此指定一系列 I/O 活动，只在整个序列执行完成后才中断 CPU
6. **I/O 模块自己有局部存储器**：（*SPOOLing 技术*）

### 直接内存访问
![[Pasted image 20230828173716.png]]
DMA 单元能够模拟处理器获得系统总线的控制权，从而进行存储器和内存的双向数据传送。

#### DMA 工作流程
1. 处理器需要读或写一块数据，则向 DMA 模块发送包含以下信息的命令
	- 请求读 or 写操作的信号，通过 DMA 模块与 CPU 之间的读写控制线发送；
	- 相关 I/O 设备的地址，通过数据线发送；
	- 从存储器中读 or 向存储器中写的起始地址，通过数据线发送并保存在 DMA 模块的地址寄存器中；
	- 读 or 写的字数，也通过数据线传送，保存在 DMA 模块的数据计数寄存器中；
2. CPU 继续执行其他工作，I/O 任务完全由 DMA 模块执行，DMA 模块直接从存储器中（或向存储器）逐字传送整块数据
3. 传送结束后，DMA 模块向 CPU 发送中断请求，CPU 执行中断处理例程

#### DMA 配置方法
![[Pasted image 20230828175008.png]]
1. 单总线，DMA 与 I/O 模块分离
	- DMA 模块充当代理处理器，通过程序控制 I/O 进行数据交换；
	- 低效原因：与 CPU 控制的程序控制 I/O 一样，先传送请求后传送数据，即每传送一个字需要两个总线周期；
2. 单总线，但 DMA 与 I/O 模块集成
	- DMA 与 I/O 模块之间不必通过系统总线，DMA 成为 I/O 系统的一部分，大大降低所需总线周期；
	- 缺点：不易扩展，增加或减少 I/O 模块都要改动 DMA 模块的接口数量
3. 多总线，系统总线与 I/O 总线分离
	- 若干 I/O 模块都连接在 I/O 总线上，DMA 模块只需要一个接口与 I/O 总线连接，
	- DMA 与 I/O 模块之间的数据交换脱离系统总线
	- 系统总线仅用于 DMA 模块与内存交换数据及处理器交换控制信号

## OS 设计问题
### 设计目标
1. 效率：I/O 操作是限制计算机系统性能的关键瓶颈
2. 通用性：设备千变万化，因此需要统一的方式处理所有设备：
	- 处理器看待 I/O 设备的方式统一（*设备是特殊文件*）
	- OS 管理 I/O 设备和 I/O 操作的方式（*虚拟化*）

### I/O 功能的逻辑结构
![[Pasted image 20230828180610.png]]
1. 逻辑外部设备：
	- 逻辑 I/O：与用户进程直接相连，不关心实际控制设备的细节，将设备当作逻辑资源来处理，允许用户进程根据设备标识符进行打开、关闭、读、写之类的交互
	- 设备 I/O：请求的操作和数据被转换为 I/O 指令序列、通道命令和控制器命令，这一层使用缓冲技术提高利用率；
	- 调度和控制：I/O 操作的排队、调度实现层，处理中断、收集并报告 I/O 状态，与设备硬件直接交互；
2. 通信端口
	- 逻辑 I/O 模块被通信架构取代，如 TCP/IP 协议层；
3. 文件系统
	- 目录管理：符号文件名被转换为标识符，采用标识符时通过文件描述符表（FDT）或索引表直接或间接地访问文件，并提供用户处理文件的接口（增删改查）
	- 文件系统：处理文件的逻辑结构和用户指定的操作，如打开、关闭、读写，以及管理访问权限；
	- 物理组织：辅存设备的物理磁道、扇区结构，对于文件和记录的逻辑访问也必须转换为物理外存地址，并且处理存储空间和内存缓冲区的分配；

## I/O 缓冲
为避免 I/O 操作时程序挂起等开销和低效操作，使用缓冲技术——在输入请求发出前就开始执行输入传送，并在输出请求发出一段时间后才开始执行输出传送。

注意区分两类 I/O 设备：
- 面向块的 I/O 设备：将信息保存在块中，块的大小通常固定，传送中一次传送一块，并且通过快号访问数据；如磁盘、USB 智能卡等设备
- 面向流的 I/O 设备：以字节流的方式 I/O，如终端、打印机、通信端口、鼠标及其它非辅存设备

### 单缓冲
![[Pasted image 20230828184248.png]]
**单缓冲方案描述**：
- 输入传送的数据被放到系统缓冲区中，传送完成时进程把该块移动到用户空间，并立即请求另一块（即*预读，预输入*）
- 数据通常是顺序访问的，由于局部性原理，在处理序列的最后才可能读入不必要的块
- 相对于无缓冲情况，单缓冲方案的用户进程可以在下一数据块读取的同时，处理已读入的数据块，因而处理与读取并行，提高了系统效率；
- 输入发生在系统内存提供的缓冲区中，而非用户进程的内存空间，因而 OS 可以安全地换出该进程；
- 准备将数据发送到一台设备时，首先将数据从用户空间复制到系统缓冲区，之后由系统缓冲区写出，提出请求的进程可以自由地继续执行或换出。

#### 单缓冲方案的负面影响
- 增加了 OS 的逻辑复杂度：OS 必须记录给用户进程分配系统缓冲区的情况；
- 影响数据块交换逻辑：I/O 操作涉及的磁盘和用于交换的磁盘相同时，磁盘写操作排队等待将进程换出到同一设备是没有任何意义的，若试图换出进程并释放内存，则要在 I/O 操作完成后才能开始，而此时进程正要使用而不能换出到磁盘；

#### 性能比较

无缓冲时，每块执行时间为 $T+C$；
- $T$：输入一个数据块所需要的时间；
- $C$：两次输入请求之间所需的计算时间。

单缓冲时，执行时间为 $max(T,C)+M$，
- $M$：数据从系统缓冲区复制到用户内存所需要的时间。

#### 单缓冲用于流式 I/O
对于面向流的 I/O，单缓冲方案能以每次传送一行的方式或每次传送一字节的方式使用：
1. 每次传送一行：适用于滚动模式的终端
	- 每次输入一行，用回车表示到达行尾，并且输出到终端时也是类似地每次输出一行，如行式打印机；
	- 用缓冲区保存单独一行数据，输入期间用户进程挂起等待整行到达，对于输出用户进程将一行输出放在缓冲区中，然后继续执行自己的后续任务;
	- 进程不需要挂起，除非第一次输出操作的缓冲区内容清空之前，又需要发出第二行输出；
2. 每次传送一字节：适用于表格式终端
	- 每次击键都很重要，如传感器、键鼠等外设；
	- OS 与用户进程之间的交互是 生产者/消费者 模型

### 双缓冲
双缓冲（又称缓冲交换 buffer swapping）方案描述：
- 一个进程向一个缓冲区传送数据的同时，OS 正在清空另一个缓冲区，当然输出数据到缓冲区也可以；

#### 性能分析
对于面向块的传送，可以粗略估计执行时间 $max(C,T)$：
- 对于 $C\le T$，面向块的设备全速运行；
- 对于 $C>T$，双缓冲可以确保进程不需要等待 I/O

#### 双缓冲用于流式 I/O
1. 对于每次传送一行的 I/O，用户进程不需要为输入或输出挂起；
2. 对于每次传送一字节的 I/O，双缓冲并不比单缓冲有明显优势；

这两种情况都是 生产者/消费者 模型

### 循环缓冲
双缓冲方案仍不足以跟得上大量 I/O 操作时，可以采用循环缓冲方案。

此时每个缓冲区都是循环缓冲区组的一个单元，对应了 有界缓冲区生产者/消费者 模型。

### 缓冲的作用
**缓冲是用来平滑 I/O 需求的峰值的技术**，对于单进程而言当计算需求大于 I/O 设备服务能力时，缓冲再多也无法满足 I/O 设备与 CPU 并驾齐驱。

但多道程序设计环境中，不同进程的计算需求和 I/O 需求各不相同，缓冲是提高 OS 和计算机系统整体效率的好办法。（*削峰填谷*思想）

## 磁盘调度

## RAID

## 磁盘缓存