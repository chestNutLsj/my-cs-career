## 流水线概述
### 流水线执行效率与特点
![[24-Pipeline-phase.png]]
特点：
- 流水线并没有缩短单个任务的延迟，但提高了整个系统的吞吐率。
- 多个任务同时运行，占用不同的资源。
- 理想的加速比 = 流水段数
- 流水线效率受限于用时最长的阶段
- 若每个阶段的用时不同，将降低流水线效率
- 装入和排空流水线也可降低加速比
- 冲突将引起流水线的暂停

作用：
- 提高处理机内部的并行性 
	- 空间并行性，即在一个处理机内设置多个独立的操作部件，并且使这些部件并行工作；
	- 时间并行性，就是采用流水线技术。流水线技术是一种非常经济、对提高计算机的运算速度非常有效的技术。采用流水线技术只需增加少量硬件就能把计算机的运算速度提高几倍，成为计算机中普遍使用的一种并行处理技术。

流水线分类：计算机各个部分几乎都可以采用流水线技术
- 指令流水线：指令的执行过程采用流水线
- 操作部件流水线：运算器中的操作部件，如浮点加法器、浮点乘法器等可以采用流水线
- 宏流水线：多个计算机之间，通过存储器连接，可以采用流水线



### 适合流水线的指令集特征

1. 指令长度应尽量一致
2. 指令格式应尽量规整，尽量保证源寄存器的位置相同
3. 采用 load/store 风格，可以保证除 load/store 外的指令都不访问存储器
4. 数据和指令在存储器中对齐存放

### 流水线执行方式与性能比较

![[24-Pipeline-operate-kinds.png]]
- 如果取指令、分析指令、执行指令的时间都相等，每段的时间都为 t，则 n 条指令所用的时间为：
	- 顺序执行：   `T=3nt`
	- 一次重叠执行：`T=(1+2n)t`
	- 两次重叠执行：`T=(n+2)t`

### 流水线的表示方法

- 流水线的每一个阶段完成一条指令的一部分， 不同阶段并行完成不同指令的不同部分。
- 流水线中的每一个阶段称为一个流水阶段，一个流水阶段与另一个流水阶段相连接形成流水线。
- 指令从流水线的一端进入，经过流水线的处理，从另一端流出。
- 目前大部分处理机的指令流水线在 3~12 段之间。

流水线常用的两种表示方法：
- 流水线连接图表示法，各个流水段顺序连接在一起
- 流水线时空图表示法，直观描述流水线工作过程

![[24-Pipeline-connection-chart.png]]

![[24-Pipeline-time-space-chart.png]]

### 流水线各阶段的要求

- 把一个任务（一条指令或一个操作）分解为几个有联系的子任务，每个子任务由一个**专门的功能部件**来实现。
- 流水线每一个功能段部件后面都要有一个缓冲寄存器，或称为锁存器，其作用是保存本流水段的结果。
	- ![[24-Pipeline-storage.png]]
- 流水线中各功能段的时间应尽量相等，否则将引起堵塞、断流。
- 要求流水线的时钟周期不能短于最慢的流水段。 只有连续不断地提供同一种任务时才能发挥流水线的效率，所以在流水线中处理的必须是连续任务。
- 流水线需要有装入时间和排空时间。
	- 装入时间是指第一个任务进入流水线到输出流水线的时间。
	- 排空时间是指第 n 个（最后一个）任务进入流水线到输出流水线的时间。

### 流水线性能指标

1. 吞吐率：单位时间执行指令的数量
2. 加速比：与串行执行时速度提高的比率

## 流水线的实现

指令执行步骤
- 取指令（IF）
- 指令译码（ID/RF）
- 指令执行（EXE）
- 读存储器（MEM）
- 写回（WB）


各步骤占用的资源
- IF：IM、PC、总线
- ID/RF：寄存器组、控制信号生成部件 EXE：ALU MEM：DM、总线 WB：寄存器组

### 划分流水段
![[24-Pipeline-segments.png]]

### 增加流水段寄存器

![[24-Pipeline-datapath-segment-registers.png]]

各阶段寄存器保存的值：
- IF/ID
	- PC+4
	- IR
- ID/EXE
	- A、B、imm、PC+4、func
	- rt/rd
- EXE/MEM
	- 运算结果：PC、ALU 结果、结果状态
	- 中间结果：B、目的寄存器
- MEM/WB
	- 目的寄存器、ALU 结果、存储器读出的结果

### 每条指令的流水段分析

#### R-type
